{% extends "core/__web.html" %}

{% block stage %}

            <style>

                @import url(http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic);

                * {
                    font-family: Lato;
                    font-weight: 400;
                }

                .placeholder {
                    font-style: italic;
                    font-weight: 300;
                    color: #DDD;
                }

            </style>

            <h1>Profile Tester</h1>

            <div id='controls'>
                <form id='profile_config'>
                    {% if profiles %}
                    <select id='profile_select'>
                        <option value='policy.base.EventProfile' selected='selected'>EventProfile (default)</option>
                        {% for path, name, profile in profiles %}
                        <option value='{{ '.'.join([path, name]) }}'>{{ name }}</option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <b>No profiles yet!</b>
                    {% endif %}
                </form>

                <br />

                <div id='spec_form'>
                    <b>Spec:</b>
                    <div id='spec_content'>

                        <span class='placeholder'>(no spec yet)</span>

                    </div><!-- end #spec_content -->
                </div><!-- end #spec_form -->

                <br />

                <div id='url_output'>
                    <b>URL:</b><br />
                    <span class='placeholder' id='url_spec'>(no url yet)</span><!-- end #url_spec -->
                </div><!-- end #url_output -->

                <br />

            </div><!-- end #controls -->

            <hr />


            <div id='deferred'></div><!-- end #deferred -->

            <div id='amp' data-host='{{ host|default('amp.sh') }}' data-tracker='{{ tracker|default('123') }}' data-mode='{{ mode|default('js') }}' hidden>
                <div id='amp-deferred' style='display: none !important;'></div>
                <script type='text/javascript'>
                    (function (ctx) {
                        var _amp = ctx._amp | [], target = (ctx.JSON && ctx.btoa) ? ['v1'] : ['v1', 'legacy'], boot_el = document.getElementById('amp'), boot = {
                            host: boot_el.getAttribute('data-host'), tracker: boot_el.getAttribute('data-tracker'), mode: boot_el.getAttribute('data-mode')},
                            debug = (boot.host == 'localhost' ? [true, target.push('debug')][0] : false), proto = (debug ? 'http:/' : 'https:/'),
                            injector = (boot.mode == 'img' ? [(frag = new Image()), (frag.src = [[proto, boot.host, 'v1', 't.gif'].join('/'),
                            ('ix&aid=' + boot.tracker)].join('?'))][0] : [(frag = document.createDocumentFragment()), (script = document.createElement('script')),
                            (script.type = 'text/javascript'), (script.src = [[proto, boot.host, target.join('/'), 't.js'].join('/'),
                            'aid=' + boot.ref].join('?')), (script.id = 'amp-runtime'), (script.defer = 'defer'), (script.async = 'async'), (frag.appendChild(script))][0]);
                            __ = (function (el) { ctx.setTimeout(function () { el.appendChild(injector) }, 0); console.log('Booting EventTracker...', injector); })(boot_el);
                    })(this);
                </script>
                <noscript><img src='//{{ host|default('amp.sh') }}/v1/t.gif?ix&aid={{ tracker|default('123') }}' /></noscript>
            </div><!-- end #amp -->

            <script id='trackertest' type='text/javascript'>

                (function boot_tester(context) {

                        // grab control elements
                    var profile_select = document.getElementById('profile_select'),
                        url_spec_output = document.getElementById('url_spec'),
                        url_spec_form = document.getElementById('spec_form'),
                        url_spec_content = document.getElementById('spec_content');

                        // `set_output_url` - sets the output URL generated from the form spec
                        function set_output_url(url) {
                            url_spec_output.classList.remove('placeholder');
                            url_spec_output.textContent = url;
                            return url;
                        }

                        // `render_spec` - renders a profile specification into an HTML form
                        function render_spec(spec) {
                            spec_content.innerHTML = spec;
                        }

                        // `generate_url` - handler on-change for profile select, queries server + renders spec form
                        function generate_url() {
                            $.apptools.api.harness.profile_spec({profile: profile_select.value}).fulfill({

                                success: function (response) {
                                    console.log('response:', response);
                                },

                                failure: function (error) {
                                    console.error('error:', error);
                                }

                            })
                        }

                        // add event listener, and we are ready
                        profile_select.addEventListener('change', generate_url);
                        console.log("Booted tracker test console.");

                })(this);

            </script><!-- end #trackertest -->

{% endblock %}

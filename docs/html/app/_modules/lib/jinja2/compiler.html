<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lib.jinja2.compiler &mdash; Hermes v2.0 Docs</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     'alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Hermes v2.0 Docs"
          href="../../../_static/opensearch.xml"/>
    <link rel="top" title="Hermes v2.0 Docs" href="../../../index.html" />
    <link rel="up" title="lib.jinja2" href="../jinja2.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Hermes</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../jinja2.html" accesskey="U">lib.jinja2</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for lib.jinja2.compiler</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    jinja2.compiler</span>
<span class="sd">    ~~~~~~~~~~~~~~~</span>

<span class="sd">    Compiles nodes into python code.</span>

<span class="sd">    :copyright: (c) 2010 by the Jinja Team.</span>
<span class="sd">    :license: BSD, see LICENSE for more details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">jinja2.nodes</span> <span class="kn">import</span> <span class="n">EvalContext</span>
<span class="kn">from</span> <span class="nn">jinja2.visitor</span> <span class="kn">import</span> <span class="n">NodeVisitor</span>
<span class="kn">from</span> <span class="nn">jinja2.exceptions</span> <span class="kn">import</span> <span class="n">TemplateAssertionError</span>
<span class="kn">from</span> <span class="nn">jinja2.utils</span> <span class="kn">import</span> <span class="n">Markup</span><span class="p">,</span> <span class="n">concat</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">is_python_keyword</span><span class="p">,</span> <span class="nb">next</span>


<span class="n">operators</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;eq&#39;</span><span class="p">:</span>       <span class="s">&#39;==&#39;</span><span class="p">,</span>
    <span class="s">&#39;ne&#39;</span><span class="p">:</span>       <span class="s">&#39;!=&#39;</span><span class="p">,</span>
    <span class="s">&#39;gt&#39;</span><span class="p">:</span>       <span class="s">&#39;&gt;&#39;</span><span class="p">,</span>
    <span class="s">&#39;gteq&#39;</span><span class="p">:</span>     <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span>
    <span class="s">&#39;lt&#39;</span><span class="p">:</span>       <span class="s">&#39;&lt;&#39;</span><span class="p">,</span>
    <span class="s">&#39;lteq&#39;</span><span class="p">:</span>     <span class="s">&#39;&lt;=&#39;</span><span class="p">,</span>
    <span class="s">&#39;in&#39;</span><span class="p">:</span>       <span class="s">&#39;in&#39;</span><span class="p">,</span>
    <span class="s">&#39;notin&#39;</span><span class="p">:</span>    <span class="s">&#39;not in&#39;</span>
<span class="p">}</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">exec</span> <span class="s">&#39;(0 if 0 else 0)&#39;</span>
<span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
    <span class="n">have_condexpr</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">have_condexpr</span> <span class="o">=</span> <span class="bp">True</span>


<span class="c"># what method to iterate over items do we want to use for dict iteration</span>
<span class="c"># in generated code?  on 2.x let&#39;s go with iteritems, on 3.x with items</span>
<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="s">&#39;iteritems&#39;</span><span class="p">):</span>
    <span class="n">dict_item_iter</span> <span class="o">=</span> <span class="s">&#39;iteritems&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">dict_item_iter</span> <span class="o">=</span> <span class="s">&#39;items&#39;</span>


<span class="c"># does if 0: dummy(x) get us x into the scope?</span>
<span class="k">def</span> <span class="nf">unoptimize_before_dead_code</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">42</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="n">dummy</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>
<span class="n">unoptimize_before_dead_code</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">unoptimize_before_dead_code</span><span class="p">()</span><span class="o">.</span><span class="n">func_closure</span><span class="p">)</span>


<div class="viewcode-block" id="generate"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.generate">[docs]</a><span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">defer_init</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate the python source for a node tree.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Template</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Can</span><span class="se">\&#39;</span><span class="s">t compile non template nodes&#39;</span><span class="p">)</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">CodeGenerator</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">defer_init</span><span class="p">)</span>
    <span class="n">generator</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">generator</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="has_safe_repr"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.has_safe_repr">[docs]</a><span class="k">def</span> <span class="nf">has_safe_repr</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does the node have a safe representation?&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">NotImplemented</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">Ellipsis</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">,</span>
                          <span class="nb">xrange</span><span class="p">,</span> <span class="n">Markup</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_safe_repr</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_safe_repr</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_safe_repr</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="find_undeclared"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.find_undeclared">[docs]</a><span class="k">def</span> <span class="nf">find_undeclared</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if the names passed are accessed undeclared.  The return value</span>
<span class="sd">    is a set of all the undeclared names from the sequence of names found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">visitor</span> <span class="o">=</span> <span class="n">UndeclaredNameVisitor</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">VisitorExit</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">visitor</span><span class="o">.</span><span class="n">undeclared</span>

</div>
<div class="viewcode-block" id="Identifiers"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Identifiers">[docs]</a><span class="k">class</span> <span class="nc">Identifiers</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tracks the status of identifiers in frames.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># variables that are known to be declared (probably from outer</span>
        <span class="c"># frames or because they are special for the frame)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># undeclared variables from outer scopes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_undeclared</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># names that are accessed without being explicitly declared by</span>
        <span class="c"># this one or any of the outer scopes.  Names can appear both in</span>
        <span class="c"># declared and undeclared.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># names that are declared locally</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_locally</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># names that are declared by parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared_parameter</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="Identifiers.add_special"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Identifiers.add_special">[docs]</a>    <span class="k">def</span> <span class="nf">add_special</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a special name like `loop`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declared</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Identifiers.is_declared"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Identifiers.is_declared">[docs]</a>    <span class="k">def</span> <span class="nf">is_declared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a name is declared in this or an outer scope.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_locally</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_parameter</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared</span>
</div>
<div class="viewcode-block" id="Identifiers.copy"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Identifiers.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Frame"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Frame">[docs]</a><span class="k">class</span> <span class="nc">Frame</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Holds compile time information for us.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_ctx</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eval_ctx</span> <span class="o">=</span> <span class="n">eval_ctx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">Identifiers</span><span class="p">()</span>

        <span class="c"># a toplevel frame is the root + soft frames such as if conditions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># the root frame is basically just the outermost frame, so no if</span>
        <span class="c"># conditions.  This information is used to optimize inheritance</span>
        <span class="c"># situations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rootlevel</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># in some dynamic inheritance situations the compiler needs to add</span>
        <span class="c"># write tests around output statements.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">require_output_check</span>

        <span class="c"># inside some tags we are using a buffer rather than yield statements.</span>
        <span class="c"># this for example affects {% filter %} or {% macro %}.  If a frame</span>
        <span class="c"># is buffered this variable points to the name of the list used as</span>
        <span class="c"># buffer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># the name of the block we&#39;re in, otherwise None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">block</span> <span class="ow">or</span> <span class="bp">None</span>

        <span class="c"># a set of actually assigned names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assigned_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># the parent of this frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span> <span class="o">|</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_parameter</span> <span class="o">|</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">assigned_names</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">outer_undeclared</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">-</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">buffer</span>

<div class="viewcode-block" id="Frame.copy"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Frame.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a copy of the current one.&quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>
</div>
<div class="viewcode-block" id="Frame.inspect"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Frame.inspect">[docs]</a>    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Walk the node and check for identifiers.  If the scope is hard (eg:</span>
<span class="sd">        enforce on a python level) overrides from outer scopes are tracked</span>
<span class="sd">        differently.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">FrameIdentifierVisitor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Frame.find_shadowed"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Frame.find_shadowed">[docs]</a>    <span class="k">def</span> <span class="nf">find_shadowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Find all the shadowed names.  extra is an iterable of variables</span>
<span class="sd">        that may be defined with `add_special` which may occour scoped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">declared</span> <span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">outer_undeclared</span><span class="p">)</span> <span class="o">&amp;</span> \
               <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">declared_locally</span> <span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">declared_parameter</span><span class="p">)</span> <span class="o">|</span> \
               <span class="nb">set</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">extra</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_declared</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Frame.inner"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Frame.inner">[docs]</a>    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an inner frame.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Frame.soft"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.Frame.soft">[docs]</a>    <span class="k">def</span> <span class="nf">soft</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a soft frame.  A soft frame may not be modified as</span>
<span class="sd">        standalone thing as it shares the resources with the frame it</span>
<span class="sd">        was created of, but it&#39;s not a rootlevel frame any longer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">rootlevel</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">rv</span>
</div>
    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">copy</span>

</div>
<div class="viewcode-block" id="VisitorExit"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.VisitorExit">[docs]</a><span class="k">class</span> <span class="nc">VisitorExit</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception used by the `UndeclaredNameVisitor` to signal a stop.&quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="DependencyFinderVisitor"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.DependencyFinderVisitor">[docs]</a><span class="k">class</span> <span class="nc">DependencyFinderVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A visitor that collects filter and test calls.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="DependencyFinderVisitor.visit_Filter"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.DependencyFinderVisitor.visit_Filter">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DependencyFinderVisitor.visit_Test"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.DependencyFinderVisitor.visit_Test">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="DependencyFinderVisitor.visit_Block"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.DependencyFinderVisitor.visit_Block">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop visiting at blocks.&quot;&quot;&quot;</span>

</div></div>
<div class="viewcode-block" id="UndeclaredNameVisitor"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.UndeclaredNameVisitor">[docs]</a><span class="k">class</span> <span class="nc">UndeclaredNameVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A visitor that checks if a name is accessed without being</span>
<span class="sd">    declared.  This is different from the frame visitor as it will</span>
<span class="sd">    not stop at closure frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="UndeclaredNameVisitor.visit_Name"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.UndeclaredNameVisitor.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s">&#39;load&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">VisitorExit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="UndeclaredNameVisitor.visit_Block"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.UndeclaredNameVisitor.visit_Block">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop visiting a blocks.&quot;&quot;&quot;</span>

</div></div>
<div class="viewcode-block" id="FrameIdentifierVisitor"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor">[docs]</a><span class="k">class</span> <span class="nc">FrameIdentifierVisitor</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A visitor for `Frame.inspect`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">identifiers</span>

<div class="viewcode-block" id="FrameIdentifierVisitor.visit_Name"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;All assignments to names go through this function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s">&#39;store&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s">&#39;param&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_parameter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s">&#39;load&#39;</span> <span class="ow">and</span> <span class="ow">not</span> \
             <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">is_declared</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_If"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_If">[docs]</a>    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="n">real_identifiers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span>

        <span class="n">old_names</span> <span class="o">=</span> <span class="n">real_identifiers</span><span class="o">.</span><span class="n">declared_locally</span> <span class="o">|</span> \
                    <span class="n">real_identifiers</span><span class="o">.</span><span class="n">declared_parameter</span>

        <span class="k">def</span> <span class="nf">inner_visit</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">real_identifiers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">subnode</span><span class="p">)</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span> <span class="o">-</span> <span class="n">old_names</span>
            <span class="c"># we have to remember the undeclared variables of this branch</span>
            <span class="c"># because we will have to pull them.</span>
            <span class="n">real_identifiers</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span> <span class="o">=</span> <span class="n">real_identifiers</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">inner_visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">else_</span> <span class="o">=</span> <span class="n">inner_visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span> <span class="ow">or</span> <span class="p">())</span>

        <span class="c"># the differences between the two branches are also pulled as</span>
        <span class="c"># undeclared variables</span>
        <span class="n">real_identifiers</span><span class="o">.</span><span class="n">undeclared</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">symmetric_difference</span><span class="p">(</span><span class="n">else_</span><span class="p">)</span> <span class="o">-</span>
                                           <span class="n">real_identifiers</span><span class="o">.</span><span class="n">declared</span><span class="p">)</span>

        <span class="c"># remember those that are declared.</span>
        <span class="n">real_identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">body</span> <span class="o">|</span> <span class="n">else_</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_Macro"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_Macro">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_Import"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_Import">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_FromImport"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_FromImport">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FromImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generic_visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_Assign"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_Assign">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visit assignments in the correct order.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_For"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_For">[docs]</a>    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visiting stops at for blocks.  However the block sequence</span>
<span class="sd">        is visited as part of the outer scope.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_CallBlock"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_CallBlock">[docs]</a>    <span class="k">def</span> <span class="nf">visit_CallBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">call</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_FilterBlock"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_FilterBlock">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FilterBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_Scope"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_Scope">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop visiting at scopes.&quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="FrameIdentifierVisitor.visit_Block"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.FrameIdentifierVisitor.visit_Block">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop visiting at blocks.&quot;&quot;&quot;</span>

</div></div>
<div class="viewcode-block" id="CompilerExit"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CompilerExit">[docs]</a><span class="k">class</span> <span class="nc">CompilerExit</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if the compiler encountered a situation where it just</span>
<span class="sd">    doesn&#39;t make sense to further process the code.  Any block that</span>
<span class="sd">    raises such an exception is not further processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="CodeGenerator"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator">[docs]</a><span class="k">class</span> <span class="nc">CodeGenerator</span><span class="p">(</span><span class="n">NodeVisitor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">defer_init</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_block_context</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defer_init</span> <span class="o">=</span> <span class="n">defer_init</span>

        <span class="c"># aliases for imports</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># a registry for all blocks.  Because blocks are moved out</span>
        <span class="c"># into the global python scope they are registered here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># the number of extends statements so far</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># some templates have a rootlevel extends.  In this case we</span>
        <span class="c"># can safely assume that we&#39;re a child template and do some</span>
        <span class="c"># more optimizations.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># the current line number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_lineno</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># registry of all filters and tests (global, not block local)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># the debug information</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># the number of new lines before the next write()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># the line number of the last written statement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_line</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># true if nothing was written so far.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_first_write</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># used by the `temporary_identifier` method to get new</span>
        <span class="c"># unique, temporary identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_identifier</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># the current indentation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># -- Various compilation helpers</span>

<div class="viewcode-block" id="CodeGenerator.fail"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.fail">[docs]</a>    <span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lineno</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fail with a :exc:`TemplateAssertionError`.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">TemplateAssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.temporary_identifier"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.temporary_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">temporary_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a new unique identifier.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_identifier</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s">&#39;t_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_identifier</span>
</div>
<div class="viewcode-block" id="CodeGenerator.buffer"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.buffer">[docs]</a>    <span class="k">def</span> <span class="nf">buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable buffering for the frame from that point onwards.&quot;&quot;&quot;</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = []&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.return_buffer_contents"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.return_buffer_contents">[docs]</a>    <span class="k">def</span> <span class="nf">return_buffer_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the buffer contents of the frame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if context.eval_ctx.autoescape:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;return Markup(concat(</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;else:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;return concat(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;return Markup(concat(</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;return concat(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.indent"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.indent">[docs]</a>    <span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Indent by one.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="CodeGenerator.outdent"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.outdent">[docs]</a>    <span class="k">def</span> <span class="nf">outdent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Outdent by step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span> <span class="o">-=</span> <span class="n">step</span>
</div>
<div class="viewcode-block" id="CodeGenerator.start_write"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.start_write">[docs]</a>    <span class="k">def</span> <span class="nf">start_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield or write into the frame buffer.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;yield &#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.append(&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.end_write"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.end_write">[docs]</a>    <span class="k">def</span> <span class="nf">end_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End the writing process started by `start_write`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.simple_write"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.simple_write">[docs]</a>    <span class="k">def</span> <span class="nf">simple_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple shortcut for start_write + write + end_write.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.blockvisit"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.blockvisit">[docs]</a>    <span class="k">def</span> <span class="nf">blockvisit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visit a list of nodes as block in a frame.  If the current frame</span>
<span class="sd">        is no buffer a dummy ``if 0: yield None`` is written automatically</span>
<span class="sd">        unless the force_generator parameter is set to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if 0: yield None&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;pass&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">CompilerExit</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="CodeGenerator.write"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a string into the output stream.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_first_write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">code_lineno</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">code_lineno</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_first_write</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;    &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indentation</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.writeline"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.writeline">[docs]</a>    <span class="k">def</span> <span class="nf">writeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Combination of newline and write.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">extra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.newline"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.newline">[docs]</a>    <span class="k">def</span> <span class="nf">newline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add one or more newlines before the next write.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_new_lines</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">extra</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_line</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_debug_info</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_line</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span>
</div>
<div class="viewcode-block" id="CodeGenerator.signature"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.signature">[docs]</a>    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes a function call to the stream for the current node.</span>
<span class="sd">        A leading comma is added automatically.  The extra keyword</span>
<span class="sd">        arguments may not include python keywords otherwise a syntax</span>
<span class="sd">        error could occour.  The extra keyword arguments should be given</span>
<span class="sd">        as python dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># if any of the given keyword arguments is a python keyword</span>
        <span class="c"># we have to make sure that no invalid call is created.</span>
        <span class="n">kwarg_workaround</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">((</span><span class="n">x</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">extra_kwargs</span> <span class="ow">or</span> <span class="p">()):</span>
            <span class="k">if</span> <span class="n">is_python_keyword</span><span class="p">(</span><span class="n">kwarg</span><span class="p">):</span>
                <span class="n">kwarg_workaround</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwarg_workaround</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">kwarg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra_kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, </span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, *&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dyn_args</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwarg_workaround</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, **dict({&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, **{&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">kwarg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">: &#39;</span> <span class="o">%</span> <span class="n">kwarg</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">kwarg</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">extra_kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">: </span><span class="si">%s</span><span class="s">, &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;}, **&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, **&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">dyn_kwargs</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.pull_locals"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.pull_locals">[docs]</a>    <span class="k">def</span> <span class="nf">pull_locals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull all the references identifiers into the local scope.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_</span><span class="si">%s</span><span class="s"> = context.resolve(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.pull_dependencies"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.pull_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">pull_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pull all the dependencies.&quot;&quot;&quot;</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="n">DependencyFinderVisitor</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="s">&#39;filters&#39;</span><span class="p">,</span> <span class="s">&#39;tests&#39;</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">dependency</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = environment.</span><span class="si">%s</span><span class="s">[</span><span class="si">%r</span><span class="s">]&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.unoptimize_scope"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.unoptimize_scope">[docs]</a>    <span class="k">def</span> <span class="nf">unoptimize_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disable Python optimizations for the frame.&quot;&quot;&quot;</span>
        <span class="c"># XXX: this is not that nice but it has no real overhead.  It</span>
        <span class="c"># mainly works because python finds the locals before dead code</span>
        <span class="c"># is removed.  If that breaks we have to add a dummy function</span>
        <span class="c"># that just accepts the arguments and does nothing.</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">dummy(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">unoptimize_before_dead_code</span> <span class="ow">and</span> <span class="s">&#39;if 0: &#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;l_&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span><span class="p">)</span>
            <span class="p">))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.push_scope"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.push_scope">[docs]</a>    <span class="k">def</span> <span class="nf">push_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">extra_vars</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;This function returns all the shadowed variables in a dict</span>
<span class="sd">        in the form name: alias and will write the required assignments</span>
<span class="sd">        into the current scope.  No indentation takes place.</span>

<span class="sd">        This also predefines locally declared variables from the loop</span>
<span class="sd">        body because under some circumstances it may be the case that</span>

<span class="sd">        `extra_vars` is passed to `Frame.find_shadowed`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">find_shadowed</span><span class="p">(</span><span class="n">extra_vars</span><span class="p">):</span>
            <span class="n">aliases</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = l_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="n">to_declare</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="n">to_declare</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;l_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_declare</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39; = &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_declare</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; = missing&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aliases</span>
</div>
<div class="viewcode-block" id="CodeGenerator.pop_scope"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.pop_scope">[docs]</a>    <span class="k">def</span> <span class="nf">pop_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aliases</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restore all aliases and delete unused variables.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span>
        <span class="n">to_delete</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="n">to_delete</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;l_&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">to_delete</span><span class="p">:</span>
            <span class="c"># we cannot use the del statement here because enclosed</span>
            <span class="c"># scopes can trigger a SyntaxError:</span>
            <span class="c">#   a = 42; b = lambda: a; del a</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39; = &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_delete</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; = missing&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.function_scoping"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.function_scoping">[docs]</a>    <span class="k">def</span> <span class="nf">function_scoping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                         <span class="n">find_special</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In Jinja a few statements require the help of anonymous</span>
<span class="sd">        functions.  Those are currently macros and call blocks and in</span>
<span class="sd">        the future also recursive loops.  As there is currently</span>
<span class="sd">        technical limitation that doesn&#39;t allow reading and writing a</span>
<span class="sd">        variable in a scope where the initial value is coming from an</span>
<span class="sd">        outer scope, this function tries to fall back with a common</span>
<span class="sd">        error message.  Additionally the frame passed is modified so</span>
<span class="sd">        that the argumetns are collected and callers are looked up.</span>

<span class="sd">        This will return the modified frame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># we have to iterate twice over it, make sure that works</span>
        <span class="k">if</span> <span class="n">children</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">()</span>
        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="n">func_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">func_frame</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

        <span class="c"># variables that are undeclared (accessed before declaration) and</span>
        <span class="c"># declared locally *and* part of an outside scope raise a template</span>
        <span class="c"># assertion error. Reason: we can&#39;t generate reasonable code from</span>
        <span class="c"># it without aliasing all the variables.</span>
        <span class="c"># this could be fixed in Python 3 where we have the nonlocal</span>
        <span class="c"># keyword or if we switch to bytecode generation</span>
        <span class="n">overriden_closure_vars</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">&amp;</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_locally</span> <span class="o">|</span>
             <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared_parameter</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">overriden_closure_vars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;It</span><span class="se">\&#39;</span><span class="s">s not possible to set and access variables &#39;</span>
                      <span class="s">&#39;derived from an outer scope! (affects: </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                      <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">overriden_closure_vars</span><span class="p">)),</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

        <span class="c"># remove variables from a closure from the frame&#39;s undeclared</span>
        <span class="c"># identifiers.</span>
        <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">-=</span> <span class="p">(</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">undeclared</span> <span class="o">&amp;</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span>
        <span class="p">)</span>

        <span class="c"># no special variables for this scope, abort early</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">find_special</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func_frame</span>

        <span class="n">func_frame</span><span class="o">.</span><span class="n">accesses_kwargs</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">func_frame</span><span class="o">.</span><span class="n">accesses_varargs</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">func_frame</span><span class="o">.</span><span class="n">accesses_caller</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">func_frame</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;l_&#39;</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>

        <span class="n">undeclared</span> <span class="o">=</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;caller&#39;</span><span class="p">,</span> <span class="s">&#39;kwargs&#39;</span><span class="p">,</span> <span class="s">&#39;varargs&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;caller&#39;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">accesses_caller</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;caller&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;l_caller&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;kwargs&#39;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">accesses_kwargs</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;kwargs&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;l_kwargs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;varargs&#39;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">accesses_varargs</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">func_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;varargs&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;l_varargs&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func_frame</span>
</div>
<div class="viewcode-block" id="CodeGenerator.macro_body"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.macro_body">[docs]</a>    <span class="k">def</span> <span class="nf">macro_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">children</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump the function def of a macro or call block.&quot;&quot;&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_scoping</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
        <span class="c"># macros are delayed, they never require output checks</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">arguments</span>
        <span class="c"># XXX: this is an ugly fix for the loop nesting bug</span>
        <span class="c"># (tests.test_old_bugs.test_loop_call_bug).  This works around</span>
        <span class="c"># a identifier nesting problem we have in general.  It&#39;s just more</span>
        <span class="c"># likely to happen in loops which is why we work around it.  The</span>
        <span class="c"># real solution would be &quot;nonlocal&quot; all the identifiers that are</span>
        <span class="c"># leaking into a new python frame and might be used both unassigned</span>
        <span class="c"># and assigned.</span>
        <span class="k">if</span> <span class="s">&#39;loop&#39;</span> <span class="ow">in</span> <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">declared</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;l_loop=l_loop&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;def macro(</span><span class="si">%s</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pull_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_buffer_contents</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">frame</span>
</div>
<div class="viewcode-block" id="CodeGenerator.macro_def"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.macro_def">[docs]</a>    <span class="k">def</span> <span class="nf">macro_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump the macro definition for the def created by macro_body.&quot;&quot;&quot;</span>
        <span class="n">arg_tuple</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arg_tuple</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Macro(environment, macro, </span><span class="si">%r</span><span class="s">, (</span><span class="si">%s</span><span class="s">), (&#39;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg_tuple</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">defaults</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;), </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">accesses_kwargs</span><span class="p">),</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">accesses_varargs</span><span class="p">),</span>
            <span class="nb">bool</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">accesses_caller</span><span class="p">)</span>
        <span class="p">))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.position"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.position">[docs]</a>    <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a human readable position for the node.&quot;&quot;&quot;</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="s">&#39;line </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">+=</span> <span class="s">&#39; in &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="c"># -- Statement Visitors</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Template"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Template">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">frame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;no root frame allowed&#39;</span>
        <span class="n">eval_ctx</span> <span class="o">=</span> <span class="n">EvalContext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">jinja2.runtime</span> <span class="kn">import</span> <span class="n">__all__</span> <span class="k">as</span> <span class="n">exported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;from __future__ import division&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;from jinja2.runtime import &#39;</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">exported</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;def run(environment):&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unoptimize_before_dead_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;dummy = lambda *x: None&#39;</span><span class="p">)</span>

        <span class="c"># if we want a deferred initialization we cannot move the</span>
        <span class="c"># environment into a local name</span>
        <span class="n">envenv</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">defer_init</span> <span class="ow">and</span> <span class="s">&#39;, environment=environment&#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># do we have an extends tag at all?  If not, we can save some</span>
        <span class="c"># overhead by just not processing any inheritance code.</span>
        <span class="n">have_extends</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Extends</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="c"># find all blocks</span>
        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Block</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;block </span><span class="si">%r</span><span class="s"> defined twice&#39;</span> <span class="o">%</span> <span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">block</span>

        <span class="c"># find all imports and import them</span>
        <span class="k">for</span> <span class="n">import_</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">ImportedName</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">import_</span><span class="o">.</span><span class="n">importname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">:</span>
                <span class="n">imp</span> <span class="o">=</span> <span class="n">import_</span><span class="o">.</span><span class="n">importname</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">[</span><span class="n">imp</span><span class="p">]</span> <span class="o">=</span> <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
                <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">imp</span><span class="p">:</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;from </span><span class="si">%s</span><span class="s"> import </span><span class="si">%s</span><span class="s"> as </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;import </span><span class="si">%s</span><span class="s"> as </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">alias</span><span class="p">))</span>

        <span class="c"># add the load name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;name = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># generate the root render function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;def root(context</span><span class="si">%s</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="n">envenv</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># process the root</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">eval_ctx</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">rootlevel</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span> <span class="o">=</span> <span class="n">have_extends</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">have_extends</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;parent_template = None&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;self&#39;</span> <span class="ow">in</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,)):</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_self = TemplateReference(context)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pull_locals</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pull_dependencies</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="c"># make sure that the parent root is called.</span>
        <span class="k">if</span> <span class="n">have_extends</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if parent_template is not None:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;for event in parent_template.&#39;</span>
                           <span class="s">&#39;root_render_func(context):&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;yield event&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">))</span>

        <span class="c"># at this point we now have the blocks collected and can visit them too.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">block_frame</span> <span class="o">=</span> <span class="n">Frame</span><span class="p">(</span><span class="n">eval_ctx</span><span class="p">)</span>
            <span class="n">block_frame</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">block_frame</span><span class="o">.</span><span class="n">block</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;def block_</span><span class="si">%s</span><span class="s">(context</span><span class="si">%s</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">envenv</span><span class="p">),</span>
                           <span class="n">block</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="n">undeclared</span> <span class="o">=</span> <span class="n">find_undeclared</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span> <span class="s">&#39;super&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;self&#39;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
                <span class="n">block_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_self = TemplateReference(context)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;super&#39;</span> <span class="ow">in</span> <span class="n">undeclared</span><span class="p">:</span>
                <span class="n">block_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;super&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_super = context.super(</span><span class="si">%r</span><span class="s">, &#39;</span>
                               <span class="s">&#39;block_</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pull_locals</span><span class="p">(</span><span class="n">block_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pull_dependencies</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">block_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;blocks = {</span><span class="si">%s</span><span class="s">}&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">: block_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                                                   <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">),</span>
                       <span class="n">extra</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># add a function that returns the debug info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;debug_info = </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span>
                                                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_info</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;return locals()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Block"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Block">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call a block and register it for the template.&quot;&quot;&quot;</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="c"># if we know that we are a child template, there is no need to</span>
            <span class="c"># check if we are one</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if parent_template is None:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">scoped</span> <span class="ow">and</span> <span class="s">&#39;context.derived(locals())&#39;</span> <span class="ow">or</span> <span class="s">&#39;context&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;for event in context.blocks[</span><span class="si">%r</span><span class="s">][0](</span><span class="si">%s</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="p">(</span>
                       <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_write</span><span class="p">(</span><span class="s">&#39;event&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Extends"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Extends">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Extends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls the extender.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;cannot use extend from a non top-level scope&#39;</span><span class="p">,</span>
                      <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

        <span class="c"># if the number of extends statements in general is zero so</span>
        <span class="c"># far, we don&#39;t have to add a check if something extended</span>
        <span class="c"># the template before this one.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c"># if we have a known extends we just add a template runtime</span>
            <span class="c"># error into the generated code.  We could catch that at compile</span>
            <span class="c"># time too, but i welcome it not to confuse users by throwing the</span>
            <span class="c"># same error at different times just &quot;because we can&quot;.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if parent_template is not None:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;raise TemplateRuntimeError(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span>
                           <span class="s">&#39;extended multiple times&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

            <span class="c"># if we have a known extends already we don&#39;t need that code here</span>
            <span class="c"># as we know that the template execution will end here.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CompilerExit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;parent_template = environment.get_template(&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;for name, parent_block in parent_template.&#39;</span>
                       <span class="s">&#39;blocks.</span><span class="si">%s</span><span class="s">():&#39;</span> <span class="o">%</span> <span class="n">dict_item_iter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.blocks.setdefault(name, []).&#39;</span>
                       <span class="s">&#39;append(parent_block)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="c"># if this extends statement was in the root level we can take</span>
        <span class="c"># advantage of that information and simplify the generated code</span>
        <span class="c"># in the top level from this point onwards</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">rootlevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># and now we have one more</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extends_so_far</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Include"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Include">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Include</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handles includes.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unoptimize_scope</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ignore_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;try:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;get_or_select_template&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Const</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;get_template&#39;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;select_template&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">List</span><span class="p">)):</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;select_template&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;template = environment.</span><span class="si">%s</span><span class="s">(&#39;</span> <span class="o">%</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ignore_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;except TemplateNotFound:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;pass&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;else:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;for event in template.root_render_func(&#39;</span>
                           <span class="s">&#39;template.new_context(context.parent, True, &#39;</span>
                           <span class="s">&#39;locals())):&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;for event in template.module._body_stream:&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simple_write</span><span class="p">(</span><span class="s">&#39;event&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ignore_missing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Import"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Import">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visit regular imports.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unoptimize_scope</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_</span><span class="si">%s</span><span class="s"> = &#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;context.vars[</span><span class="si">%r</span><span class="s">] = &#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.get_template(&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, </span><span class="si">%r</span><span class="s">).&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;make_module(context.parent, True, locals())&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;module&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.exported_vars.discard(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">assigned_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_FromImport"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_FromImport">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FromImport</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Visit named imports.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;included_template = environment.get_template(&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, </span><span class="si">%r</span><span class="s">).&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">with_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;make_module(context.parent, True)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;module&#39;</span><span class="p">)</span>

        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">discarded_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alias</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_</span><span class="si">%s</span><span class="s"> = getattr(included_template, &#39;</span>
                           <span class="s">&#39;</span><span class="si">%r</span><span class="s">, missing)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if l_</span><span class="si">%s</span><span class="s"> is missing:&#39;</span> <span class="o">%</span> <span class="n">alias</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;l_</span><span class="si">%s</span><span class="s"> = environment.undefined(</span><span class="si">%r</span><span class="s"> </span><span class="si">%%</span><span class="s"> &#39;</span>
                           <span class="s">&#39;included_template.__name__, &#39;</span>
                           <span class="s">&#39;name=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s">&#39;the template </span><span class="si">%%</span><span class="s">r (imported on </span><span class="si">%s</span><span class="s">) does &#39;</span>
                           <span class="s">&#39;not export the requested name </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">node</span><span class="p">),</span>
                                <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                           <span class="p">),</span> <span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
                <span class="n">var_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">alias</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
                    <span class="n">discarded_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">assigned_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">var_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.vars[</span><span class="si">%r</span><span class="s">] = l_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.vars.update({</span><span class="si">%s</span><span class="s">})&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s">&#39;</span><span class="si">%r</span><span class="s">: l_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">var_names</span>
                <span class="p">))</span>
        <span class="k">if</span> <span class="n">discarded_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discarded_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.exported_vars.discard(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span>
                               <span class="n">discarded_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.exported_vars.difference_&#39;</span>
                               <span class="s">&#39;update((</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">discarded_names</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_For"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_For">[docs]</a>    <span class="k">def</span> <span class="nf">visit_For</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c"># when calculating the nodes for the inner frame we have to exclude</span>
        <span class="c"># the iterator contents from it</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;iter&#39;</span><span class="p">,))</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="n">loop_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_scoping</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span>
                                               <span class="n">find_special</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loop_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
            <span class="n">loop_frame</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>

        <span class="c"># try to figure out if we have an extended loop.  An extended loop</span>
        <span class="c"># is necessary if the loop is in recursive mode if the special loop</span>
        <span class="c"># variable is accessed in the body.</span>
        <span class="n">extended_loop</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span> <span class="ow">or</span> <span class="s">&#39;loop&#39;</span> <span class="ow">in</span> \
                        <span class="n">find_undeclared</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span>
                            <span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,)),</span> <span class="p">(</span><span class="s">&#39;loop&#39;</span><span class="p">,))</span>

        <span class="c"># if we don&#39;t have an recursive loop we have to find the shadowed</span>
        <span class="c"># variables at that point.  Because loops can be nested but the loop</span>
        <span class="c"># variable is a special one we have to enforce aliasing for it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;loop&#39;</span><span class="p">,))</span>

        <span class="c"># otherwise we set up a buffer and add a function def</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;def loop(reciter, loop_render_func):&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">)</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># make sure the loop variable is a special one and raise a template</span>
        <span class="c"># assertion error if a loop tries to write to loop</span>
        <span class="k">if</span> <span class="n">extended_loop</span><span class="p">:</span>
            <span class="n">loop_frame</span><span class="o">.</span><span class="n">identifiers</span><span class="o">.</span><span class="n">add_special</span><span class="p">(</span><span class="s">&#39;loop&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s">&#39;store&#39;</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;loop&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Can</span><span class="se">\&#39;</span><span class="s">t assign to special loop variable &#39;</span>
                          <span class="s">&#39;in for-loop target&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pull_locals</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="n">iteration_indicator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = 1&#39;</span> <span class="o">%</span> <span class="n">iteration_indicator</span><span class="p">)</span>

        <span class="c"># Create a fake parent loop if the else or test section of a</span>
        <span class="c"># loop is accessing the special loop variable and no parent loop</span>
        <span class="c"># exists.</span>
        <span class="k">if</span> <span class="s">&#39;loop&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aliases</span> <span class="ow">and</span> <span class="s">&#39;loop&#39;</span> <span class="ow">in</span> <span class="n">find_undeclared</span><span class="p">(</span>
           <span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">only</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;else_&#39;</span><span class="p">,</span> <span class="s">&#39;test&#39;</span><span class="p">)),</span> <span class="p">(</span><span class="s">&#39;loop&#39;</span><span class="p">,)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&quot;l_loop = environment.undefined(</span><span class="si">%r</span><span class="s">, name=&#39;loop&#39;)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="s">&quot;&#39;loop&#39; is undefined. the filter section of a loop as well &quot;</span>
                 <span class="s">&quot;as the else block don&#39;t have access to the special &#39;loop&#39;&quot;</span>
                 <span class="s">&quot; variable of the current loop.  Because there is no parent &quot;</span>
                 <span class="s">&quot;loop it&#39;s undefined.  Happened in loop on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;for &#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">extended_loop</span> <span class="ow">and</span> <span class="s">&#39;, l_loop in LoopContext(&#39;</span> <span class="ow">or</span> <span class="s">&#39; in &#39;</span><span class="p">)</span>

        <span class="c"># if we have an extened loop and a node test, we filter in the</span>
        <span class="c"># &quot;outer frame&quot;.</span>
        <span class="k">if</span> <span class="n">extended_loop</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; for &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; in &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;reciter&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; if (&#39;</span><span class="p">)</span>
            <span class="n">test_frame</span> <span class="o">=</span> <span class="n">loop_frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">test_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;))&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;reciter&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, recurse=loop_render_func):&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">extended_loop</span> <span class="ow">and</span> <span class="s">&#39;):&#39;</span> <span class="ow">or</span> <span class="s">&#39;:&#39;</span><span class="p">)</span>

        <span class="c"># tests in not extended loops become a continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">extended_loop</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if not &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;continue&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = 0&#39;</span> <span class="o">%</span> <span class="n">iteration_indicator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if </span><span class="si">%s</span><span class="s">:&#39;</span> <span class="o">%</span> <span class="n">iteration_indicator</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>

        <span class="c"># reset the aliases if there are any.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="n">loop_frame</span><span class="p">)</span>

        <span class="c"># if the node was recursive we have to return the buffer contents</span>
        <span class="c"># and start the iteration code</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">recursive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">return_buffer_contents</span><span class="p">(</span><span class="n">loop_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;loop(&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, loop)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_If"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_If">[docs]</a>    <span class="k">def</span> <span class="nf">visit_If</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">if_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">soft</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if &#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;else:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">else_</span><span class="p">,</span> <span class="n">if_frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Macro"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Macro">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">macro_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_body</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;context.exported_vars.add(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.vars[</span><span class="si">%r</span><span class="s">] = &#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;l_</span><span class="si">%s</span><span class="s"> = &#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_def</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">macro_frame</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">assigned_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_CallBlock"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_CallBlock">[docs]</a>    <span class="k">def</span> <span class="nf">visit_CallBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;call&#39;</span><span class="p">,))</span>
        <span class="n">call_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">macro_body</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;caller = &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macro_def</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">call_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_Call</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">call</span><span class="p">,</span> <span class="n">call_frame</span><span class="p">,</span> <span class="n">forward_caller</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_FilterBlock"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_FilterBlock">[docs]</a>    <span class="k">def</span> <span class="nf">visit_FilterBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">filter_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">filter_frame</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">())</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pull_locals</span><span class="p">(</span><span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_write</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_Filter</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">filter</span><span class="p">,</span> <span class="n">filter_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_write</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="n">filter_frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_ExprStmt"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_ExprStmt">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ExprStmt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Output"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Output">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c"># if we have a known extends statement, we don&#39;t output anything</span>
        <span class="c"># if we are in a require_output_check section</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_known_extends</span> <span class="ow">and</span> <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">finalize</span><span class="p">:</span>
            <span class="n">finalize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalize</span> <span class="o">=</span> <span class="nb">unicode</span>

        <span class="c"># if we are inside a frame that requires output checking, we do so</span>
        <span class="n">outdent_later</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">require_output_check</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;if parent_template is None:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="n">outdent_later</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># try to evaluate as many chunks as possible into a static</span>
        <span class="c"># string at compile time.</span>
        <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">const</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c"># the frame can&#39;t be volatile here, becaus otherwise the</span>
            <span class="c"># as_const() function would raise an Impossible exception</span>
            <span class="c"># at that point.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">const</span><span class="p">,</span> <span class="s">&#39;__html__&#39;</span><span class="p">):</span>
                        <span class="n">const</span> <span class="o">=</span> <span class="n">const</span><span class="o">.</span><span class="n">__html__</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">const</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
                <span class="n">const</span> <span class="o">=</span> <span class="n">finalize</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c"># if something goes wrong here we evaluate the node</span>
                <span class="c"># at runtime for easier debugging</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">body</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">const</span><span class="p">])</span>

        <span class="c"># if we have less than 3 nodes or a buffer we yield or extend/append</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># for one item we append, for more we extend</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.append(&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.extend((&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;yield &#39;</span> <span class="o">+</span> <span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;yield &#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">close</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(context.eval_ctx.autoescape and&#39;</span>
                                   <span class="s">&#39; escape or to_string)(&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;escape(&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;to_string(&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">finalize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.finalize(&#39;</span><span class="p">)</span>
                        <span class="n">close</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span> <span class="o">*</span> <span class="n">close</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># close the open parentheses</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s">&#39;)&#39;</span> <span class="ow">or</span> <span class="s">&#39;))&#39;</span><span class="p">)</span>

        <span class="c"># otherwise we create a format string as this is faster in that case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">format</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%%</span><span class="s">&#39;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">format</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="n">arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;yield &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">concat</span><span class="p">(</span><span class="n">format</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39; % (&#39;</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indent</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">arguments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span>
                <span class="n">close</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(context.eval_ctx.autoescape and&#39;</span>
                               <span class="s">&#39; escape or to_string)(&#39;</span><span class="p">)</span>
                    <span class="n">close</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;escape(&#39;</span><span class="p">)</span>
                    <span class="n">close</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">finalize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.finalize(&#39;</span><span class="p">)</span>
                    <span class="n">close</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span> <span class="o">*</span> <span class="n">close</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outdent_later</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdent</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Assign"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Assign">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c"># toplevel assignments however go into the local namespace and</span>
        <span class="c"># the current template&#39;s context.  We create a copy of the frame</span>
        <span class="c"># here and add a set so that the Name visitor can add the assigned</span>
        <span class="c"># names here.</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="n">assignment_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">assignment_frame</span><span class="o">.</span><span class="n">toplevel_assignments</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assignment_frame</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">assignment_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; = &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

        <span class="c"># make sure toplevel assignments are added to the context.</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="n">public_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">assignment_frame</span><span class="o">.</span><span class="n">toplevel_assignments</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignment_frame</span><span class="o">.</span><span class="n">toplevel_assignments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">assignment_frame</span><span class="o">.</span><span class="n">toplevel_assignments</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.vars[</span><span class="si">%r</span><span class="s">] = l_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.vars.update({&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">assignment_frame</span><span class="o">.</span><span class="n">toplevel_assignments</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s">: l_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;})&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">public_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">public_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.exported_vars.add(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span>
                                   <span class="n">public_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.exported_vars.update((</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span>
                                   <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">public_names</span><span class="p">)))</span>

    <span class="c"># -- Expression Visitors</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Name"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Name">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">ctx</span> <span class="o">==</span> <span class="s">&#39;store&#39;</span> <span class="ow">and</span> <span class="n">frame</span><span class="o">.</span><span class="n">toplevel</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">toplevel_assignments</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;l_&#39;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">assigned_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Const"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Const">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Const</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_TemplateData"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_TemplateData">[docs]</a>    <span class="k">def</span> <span class="nf">visit_TemplateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(context.eval_ctx.autoescape and Markup or identity)(</span><span class="si">%r</span><span class="s">)&#39;</span>
                       <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Tuple"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Tuple">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s">&#39;,)&#39;</span> <span class="ow">or</span> <span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_List"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_List">[docs]</a>    <span class="k">def</span> <span class="nf">visit_List</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Dict"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Dict">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;: &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">binop</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">interceptable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sandboxed</span> <span class="ow">and</span> \
               <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">intercepted_binops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.call_binop(context, </span><span class="si">%r</span><span class="s">, &#39;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span>

    <span class="k">def</span> <span class="nf">uaop</span><span class="p">(</span><span class="n">operator</span><span class="p">,</span> <span class="n">interceptable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sandboxed</span> <span class="ow">and</span> \
               <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">intercepted_unops</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.call_unop(context, </span><span class="si">%r</span><span class="s">, &#39;</span> <span class="o">%</span> <span class="n">operator</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(&#39;</span> <span class="o">+</span> <span class="n">operator</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">visitor</span>

    <span class="n">visit_Add</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">visit_Sub</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">visit_Mul</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span>
    <span class="n">visit_Div</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">visit_FloorDiv</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">)</span>
    <span class="n">visit_Pow</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;**&#39;</span><span class="p">)</span>
    <span class="n">visit_Mod</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">)</span>
    <span class="n">visit_And</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;and&#39;</span><span class="p">,</span> <span class="n">interceptable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">visit_Or</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="s">&#39;or&#39;</span><span class="p">,</span> <span class="n">interceptable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">visit_Pos</span> <span class="o">=</span> <span class="n">uaop</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">visit_Neg</span> <span class="o">=</span> <span class="n">uaop</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">visit_Not</span> <span class="o">=</span> <span class="n">uaop</span><span class="p">(</span><span class="s">&#39;not &#39;</span><span class="p">,</span> <span class="n">interceptable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">binop</span><span class="p">,</span> <span class="n">uaop</span>

<div class="viewcode-block" id="CodeGenerator.visit_Concat"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Concat">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;(context.eval_ctx.volatile and&#39;</span> \
                        <span class="s">&#39; markup_join or unicode_join)&#39;</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;markup_join&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="s">&#39;unicode_join&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">((&#39;</span> <span class="o">%</span> <span class="n">func_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;))&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Compare"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Compare">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Operand"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Operand">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Operand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">operators</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Getattr"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Getattr">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.getattr(&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">attr</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Getitem"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Getitem">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Getitem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="c"># slices bypass the environment getitem method.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Slice</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.getitem(&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Slice"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Slice">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">stop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">step</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Filter"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Filter">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;(&#39;</span><span class="p">)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;no filter named </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;contextfilter&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;context, &#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;evalcontextfilter&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;context.eval_ctx, &#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">&#39;environmentfilter&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment, &#39;</span><span class="p">)</span>

        <span class="c"># if the filter node is None we are inside a filter block</span>
        <span class="c"># and want to write to the current buffer</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(context.eval_ctx.autoescape and&#39;</span>
                       <span class="s">&#39; Markup(concat(</span><span class="si">%s</span><span class="s">)) or concat(</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span>
                       <span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">autoescape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Markup(concat(</span><span class="si">%s</span><span class="s">))&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;concat(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">buffer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Test"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Test">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;(&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">tests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;no test named </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_CondExpr"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_CondExpr">[docs]</a>    <span class="k">def</span> <span class="nf">visit_CondExpr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">write_expr2</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">expr2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr2</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.undefined(</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;the inline if-&#39;</span>
                       <span class="s">&#39;expression on </span><span class="si">%s</span><span class="s"> evaluated to false and &#39;</span>
                       <span class="s">&#39;no else section was defined.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">node</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">have_condexpr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;((&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;) and (&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;,) or (&#39;</span><span class="p">)</span>
            <span class="n">write_expr2</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;,))[0]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr1</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; if &#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; else &#39;</span><span class="p">)</span>
            <span class="n">write_expr2</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Call"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Call">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">forward_caller</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">sandboxed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.call(context, &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;context.call(&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">forward_caller</span> <span class="ow">and</span> <span class="p">{</span><span class="s">&#39;caller&#39;</span><span class="p">:</span> <span class="s">&#39;caller&#39;</span><span class="p">}</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">extra_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Keyword"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Keyword">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;=&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

    <span class="c"># -- Unused nodes for extensions</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_MarkSafe"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_MarkSafe">[docs]</a>    <span class="k">def</span> <span class="nf">visit_MarkSafe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Markup(&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_MarkSafeIfAutoescape"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_MarkSafeIfAutoescape">[docs]</a>    <span class="k">def</span> <span class="nf">visit_MarkSafeIfAutoescape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;(context.eval_ctx.autoescape and Markup or identity)(&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_EnvironmentAttribute"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_EnvironmentAttribute">[docs]</a>    <span class="k">def</span> <span class="nf">visit_EnvironmentAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.&#39;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_ExtensionAttribute"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_ExtensionAttribute">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ExtensionAttribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;environment.extensions[</span><span class="si">%r</span><span class="s">].</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_ImportedName"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_ImportedName">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ImportedName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">import_aliases</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">importname</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_InternalName"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_InternalName">[docs]</a>    <span class="k">def</span> <span class="nf">visit_InternalName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_ContextReference"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_ContextReference">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ContextReference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;context&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Continue"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Continue">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;continue&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Break"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Break">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Break</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;break&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_Scope"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_Scope">[docs]</a>    <span class="k">def</span> <span class="nf">visit_Scope</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">scope_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">inner</span><span class="p">()</span>
        <span class="n">scope_frame</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">iter_child_nodes</span><span class="p">())</span>
        <span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_scope</span><span class="p">(</span><span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pull_locals</span><span class="p">(</span><span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blockvisit</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">scope_frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pop_scope</span><span class="p">(</span><span class="n">aliases</span><span class="p">,</span> <span class="n">scope_frame</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_EvalContextModifier"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_EvalContextModifier">[docs]</a>    <span class="k">def</span> <span class="nf">visit_EvalContextModifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.eval_ctx.</span><span class="si">%s</span><span class="s"> = &#39;</span> <span class="o">%</span> <span class="n">keyword</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">keyword</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">keyword</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">as_const</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Impossible</span><span class="p">:</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">volatile</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="p">,</span> <span class="n">keyword</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CodeGenerator.visit_ScopedEvalContextModifier"><a class="viewcode-back" href="../../../lib.jinja2.html#lib.jinja2.compiler.CodeGenerator.visit_ScopedEvalContextModifier">[docs]</a>    <span class="k">def</span> <span class="nf">visit_ScopedEvalContextModifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">old_ctx_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporary_identifier</span><span class="p">()</span>
        <span class="n">safed_ctx</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = context.eval_ctx.save()&#39;</span> <span class="o">%</span> <span class="n">old_ctx_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visit_EvalContextModifier</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">eval_ctx</span><span class="o">.</span><span class="n">revert</span><span class="p">(</span><span class="n">safed_ctx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeline</span><span class="p">(</span><span class="s">&#39;context.eval_ctx.revert(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">old_ctx_name</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/ampush-logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Hermes</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../jinja2.html" >lib.jinja2</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ampush, Inc.
    </div>
  </body>
</html>
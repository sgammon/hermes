<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lib.webapp2 &mdash; Hermes v2.0 Docs</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Hermes v2.0 Docs"
          href="../../_static/opensearch.xml"/>
    <link rel="top" title="Hermes v2.0 Docs" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hermes</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for lib.webapp2</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    webapp2</span>
<span class="sd">    =======</span>

<span class="sd">    Taking Google App Engine&#39;s webapp to the next level!</span>

<span class="sd">    :copyright: 2011 by tipfy.org.</span>
<span class="sd">    :license: Apache Sotware License, see LICENSE for details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>

<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">from</span> <span class="nn">wsgiref</span> <span class="kn">import</span> <span class="n">handlers</span>

<span class="kn">import</span> <span class="nn">webob</span>
<span class="kn">from</span> <span class="nn">webob</span> <span class="kn">import</span> <span class="n">exc</span>

<span class="n">_webapp</span> <span class="o">=</span> <span class="n">_webapp_util</span> <span class="o">=</span> <span class="n">_local</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="c"># WebOb &lt; 1.0 (App Engine Python 2.5).</span>
    <span class="kn">from</span> <span class="nn">webob.statusreasons</span> <span class="kn">import</span> <span class="n">status_reasons</span>
    <span class="kn">from</span> <span class="nn">webob.headerdict</span> <span class="kn">import</span> <span class="n">HeaderDict</span> <span class="k">as</span> <span class="n">BaseResponseHeaders</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="c"># WebOb &gt;= 1.0.</span>
    <span class="kn">from</span> <span class="nn">webob.util</span> <span class="kn">import</span> <span class="n">status_reasons</span>
    <span class="kn">from</span> <span class="nn">webob.headers</span> <span class="kn">import</span> <span class="n">ResponseHeaders</span> <span class="k">as</span> <span class="n">BaseResponseHeaders</span>

<span class="c"># google.appengine.ext.webapp imports webapp2 in the</span>
<span class="c"># App Engine Python 2.7 runtime.</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;APPENGINE_RUNTIME&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;python27&#39;</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">google.appengine.ext</span> <span class="kn">import</span> <span class="n">webapp</span> <span class="k">as</span> <span class="n">_webapp</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
        <span class="c"># Running webapp2 outside of GAE.</span>
        <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">google.appengine.ext.webapp</span> <span class="kn">import</span> <span class="n">util</span> <span class="k">as</span> <span class="n">_webapp_util</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="c"># Thread-local variables container.</span>
    <span class="kn">from</span> <span class="nn">webapp2_extras</span> <span class="kn">import</span> <span class="n">local</span>
    <span class="n">_local</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">Local</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;webapp2_extras.local is not available &quot;</span>
                    <span class="s">&quot;so webapp2 won&#39;t be thread-safe!&quot;</span><span class="p">)</span>


<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">__version_info__</span><span class="p">)</span>

<span class="c">#: Base HTTP exception, set here as public interface.</span>
<span class="n">HTTPException</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPException</span>

<span class="c">#: Regex for route definitions.</span>
<span class="n">_route_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;</span>
<span class="s">    \&lt;               # The exact character &quot;&lt;&quot;</span>
<span class="s">    ([a-zA-Z_]\w*)?  # The optional variable name</span>
<span class="s">    (?:\:([^\&gt;]*))?  # The optional :regex part</span>
<span class="s">    \&gt;               # The exact character &quot;&gt;&quot;</span>
<span class="s">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
<span class="c">#: Regex extract charset from environ.</span>
<span class="n">_charset_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;;\s*charset=([^;]*)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

<span class="c"># Set same default messages from webapp plus missing ones.</span>
<span class="n">_webapp_status_reasons</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">203</span><span class="p">:</span> <span class="s">&#39;Non-Authoritative Information&#39;</span><span class="p">,</span>
    <span class="mi">302</span><span class="p">:</span> <span class="s">&#39;Moved Temporarily&#39;</span><span class="p">,</span>
    <span class="mi">306</span><span class="p">:</span> <span class="s">&#39;Unused&#39;</span><span class="p">,</span>
    <span class="mi">408</span><span class="p">:</span> <span class="s">&#39;Request Time-out&#39;</span><span class="p">,</span>
    <span class="mi">414</span><span class="p">:</span> <span class="s">&#39;Request-URI Too Large&#39;</span><span class="p">,</span>
    <span class="mi">504</span><span class="p">:</span> <span class="s">&#39;Gateway Time-out&#39;</span><span class="p">,</span>
    <span class="mi">505</span><span class="p">:</span> <span class="s">&#39;HTTP Version not supported&#39;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">status_reasons</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_webapp_status_reasons</span><span class="p">)</span>
<span class="k">for</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">_webapp_status_reasons</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cls</span><span class="p">:</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">message</span>


<div class="viewcode-block" id="Request"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Request">[docs]</a><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">webob</span><span class="o">.</span><span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstraction for an HTTP request.</span>

<span class="sd">    Most extra methods and attributes are ported from webapp. Check the</span>
<span class="sd">    `WebOb documentation &lt;WebOb&gt;`_ for the ones not listed here.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: A reference to the active :class:`WSGIApplication` instance.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A reference to the active :class:`Response` instance.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A reference to the matched :class:`Route`.</span>
    <span class="n">route</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: The matched route positional arguments.</span>
    <span class="n">route_args</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: The matched route keyword arguments.</span>
    <span class="n">route_kwargs</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A dictionary to register objects used during the request lifetime.</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Attributes from webapp.</span>
    <span class="n">request_body_tempfile_limit</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a Request object from a WSGI environment.</span>

<span class="sd">        :param environ:</span>
<span class="sd">            A WSGI-compliant environment dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;charset&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">_charset_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">charset</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">charset</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>

            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;charset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charset</span>

        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;unicode_errors&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;decode_param_names&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Request</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Request.get"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Request.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument_name</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">allow_multiple</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the query or POST argument with the given name.</span>

<span class="sd">        We parse the query string and POST payload lazily, so this will be a</span>
<span class="sd">        slower operation on the first call.</span>

<span class="sd">        :param argument_name:</span>
<span class="sd">            The name of the query or POST argument.</span>
<span class="sd">        :param default_value:</span>
<span class="sd">            The value to return if the given argument is not present.</span>
<span class="sd">        :param allow_multiple:</span>
<span class="sd">            Return a list of values with the given name (deprecated).</span>
<span class="sd">        :returns:</span>
<span class="sd">            If allow_multiple is False (which it is by default), we return</span>
<span class="sd">            the first value with the given name given in the request. If it</span>
<span class="sd">            is True, we always return a list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">argument_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allow_multiple</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;allow_multiple is a deprecated param. &#39;</span>
                <span class="s">&#39;Please use the Request.get_all() method instead.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allow_multiple</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">param_value</span>

            <span class="k">return</span> <span class="n">param_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">allow_multiple</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">default_value</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="k">return</span> <span class="n">default_value</span>
</div>
<div class="viewcode-block" id="Request.get_all"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Request.get_all">[docs]</a>    <span class="k">def</span> <span class="nf">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument_name</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of query or POST arguments with the given name.</span>

<span class="sd">        We parse the query string and POST payload lazily, so this will be a</span>
<span class="sd">        slower operation on the first call.</span>

<span class="sd">        :param argument_name:</span>
<span class="sd">            The name of the query or POST argument.</span>
<span class="sd">        :param default_value:</span>
<span class="sd">            The value to return if the given argument is not present,</span>
<span class="sd">            None may not be used as a default, if it is then an empty</span>
<span class="sd">            list will be returned instead.</span>
<span class="sd">        :returns:</span>
<span class="sd">            A (possibly empty) list of values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">:</span>
            <span class="n">argument_name</span> <span class="o">=</span> <span class="n">argument_name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">default_value</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">param_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="n">argument_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">param_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_value</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_value</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">):</span>
                <span class="n">param_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

        <span class="k">return</span> <span class="n">param_value</span>
</div>
<div class="viewcode-block" id="Request.arguments"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Request.arguments">[docs]</a>    <span class="k">def</span> <span class="nf">arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of the arguments provided in the query and/or POST.</span>

<span class="sd">        The return value is a list of strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="Request.get_range"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Request.get_range">[docs]</a>    <span class="k">def</span> <span class="nf">get_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parses the given int argument, limiting it to the given range.</span>

<span class="sd">        :param name:</span>
<span class="sd">            The name of the argument.</span>
<span class="sd">        :param min_value:</span>
<span class="sd">            The minimum int value of the argument (if any).</span>
<span class="sd">        :param max_value:</span>
<span class="sd">            The maximum int value of the argument (if any).</span>
<span class="sd">        :param default:</span>
<span class="sd">            The default value of the argument if it is not given.</span>
<span class="sd">        :returns:</span>
<span class="sd">            An int within the given range for the argument.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">default</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_value</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Request.blank"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Request.blank">[docs]</a>    <span class="k">def</span> <span class="nf">blank</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">headers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c"># pragma: no cover</span>
        <span class="sd">&quot;&quot;&quot;Adds parameters compatible with WebOb &gt;= 1.0: POST and **kwargs.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Request</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="n">environ</span><span class="p">,</span>
                                             <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span>
                                             <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
            <span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;POST&#39;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;wsgi.input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;webob.is_body_seekable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">environ</span><span class="p">[</span><span class="s">&#39;CONTENT_TYPE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span>

        <span class="n">base</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">Request</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="n">environ</span><span class="p">,</span>
                                         <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">cls</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base</span>

</div></div>
<div class="viewcode-block" id="ResponseHeaders"><a class="viewcode-back" href="../../lib.html#lib.webapp2.ResponseHeaders">[docs]</a><span class="k">class</span> <span class="nc">ResponseHeaders</span><span class="p">(</span><span class="n">BaseResponseHeaders</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements methods from ``wsgiref.headers.Headers``, used by webapp.&quot;&quot;&quot;</span>

    <span class="n">get_all</span> <span class="o">=</span> <span class="n">BaseResponseHeaders</span><span class="o">.</span><span class="n">getall</span>

<div class="viewcode-block" id="ResponseHeaders.add_header"><a class="viewcode-back" href="../../lib.html#lib.webapp2.ResponseHeaders.add_header">[docs]</a>    <span class="k">def</span> <span class="nf">add_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_value</span><span class="p">,</span> <span class="o">**</span><span class="n">_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extended header setting.</span>

<span class="sd">        _name is the header field to add.  keyword arguments can be used to set</span>
<span class="sd">        additional parameters for the header field, with underscores converted</span>
<span class="sd">        to dashes.  Normally the parameter will be added as key=&quot;value&quot; unless</span>
<span class="sd">        value is None, in which case only the key will be added.</span>

<span class="sd">        Example::</span>

<span class="sd">            h.add_header(&#39;content-disposition&#39;, &#39;attachment&#39;,</span>
<span class="sd">                         filename=&#39;bud.gif&#39;)</span>

<span class="sd">        Note that unlike the corresponding &#39;email.message&#39; method, this does</span>
<span class="sd">        *not* handle &#39;(charset, language, value)&#39; tuples: all values must be</span>
<span class="sd">        strings or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\\\\</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;&#39;</span><span class="p">)</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the formatted headers ready for HTTP transmission.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="Response"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response">[docs]</a><span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">webob</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Abstraction for an HTTP response.</span>

<span class="sd">    Most extra methods and attributes are ported from webapp. Check the</span>
<span class="sd">    `WebOb documentation &lt;WebOb&gt;`_ for the ones not listed here.</span>

<span class="sd">    Differences from webapp.Response:</span>

<span class="sd">    - ``out`` is not a ``StringIO.StringIO`` instance. Instead it is the</span>
<span class="sd">      response itself, as it has the method ``write()``.</span>
<span class="sd">    - As in WebOb, ``status`` is the code plus message, e.g., &#39;200 OK&#39;, while</span>
<span class="sd">      in webapp it is the integer code. The status code as an integer is</span>
<span class="sd">      available in ``status_int``, and the status message is available in</span>
<span class="sd">      ``status_message``.</span>
<span class="sd">    - ``response.headers`` raises an exception when a key that doesn&#39;t exist</span>
<span class="sd">      is accessed or deleted, differently from ``wsgiref.headers.Headers``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: Default charset as in webapp.</span>
    <span class="n">default_charset</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a response with the default settings.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;no-cache&#39;</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Response.out"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.out">[docs]</a>    <span class="k">def</span> <span class="nf">out</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A reference to the Response instance itself, for compatibility with</span>
<span class="sd">        webapp only: webapp uses `Response.out.write()`, so we point `out` to</span>
<span class="sd">        `self` and it will use `Response.write()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Response.write"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Appends a text to the response body.&quot;&quot;&quot;</span>
        <span class="c"># webapp uses StringIO as Response.out, so we need to convert anything</span>
        <span class="c"># that is not str or unicode to string to keep same behavior.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_charset</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The status string, including code and message.&quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Accept long because urlfetch in App Engine returns codes as longs.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="c"># Status messages have to be ASCII safe, so this is OK.</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="s">&#39;You must set status to a string or integer (not </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="n">parts</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">message</span> <span class="ow">or</span> <span class="n">Response</span><span class="o">.</span><span class="n">http_status_message</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span>

    <span class="n">status</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_status</span><span class="p">,</span> <span class="n">_set_status</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_set_status</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>

<div class="viewcode-block" id="Response.set_status"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the HTTP status code of this response.</span>

<span class="sd">        :param code:</span>
<span class="sd">            The HTTP status string to use</span>
<span class="sd">        :param message:</span>
<span class="sd">            A status string. If none is given, uses the default from the</span>
<span class="sd">            HTTP/1.1 specification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">code</span>
</div>
    <span class="k">def</span> <span class="nf">_get_status_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The response status message, as a string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_set_status_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_int</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="n">status_message</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_status_message</span><span class="p">,</span> <span class="n">_set_status_message</span><span class="p">,</span>
                              <span class="n">doc</span><span class="o">=</span><span class="n">_get_status_message</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The headers as a dictionary-like object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">ResponseHeaders</span><span class="o">.</span><span class="n">view_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span>

    <span class="k">def</span> <span class="nf">_set_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Response headers must be a list or dictionary.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_headers</span><span class="p">,</span> <span class="n">_set_headers</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_get_headers</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>

<div class="viewcode-block" id="Response.has_error"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.has_error">[docs]</a>    <span class="k">def</span> <span class="nf">has_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Indicates whether the response was an error response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_int</span> <span class="o">&gt;=</span> <span class="mi">400</span>
</div>
<div class="viewcode-block" id="Response.clear"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears all data written to the output stream so that it is empty.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="Response.wsgi_write"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.wsgi_write">[docs]</a>    <span class="k">def</span> <span class="nf">wsgi_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes this response using using the given WSGI function.</span>

<span class="sd">        This is only here for compatibility with ``webapp.WSGIApplication``.</span>

<span class="sd">        :param start_response:</span>
<span class="sd">            The WSGI-compatible start_response function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;no-cache&#39;</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Expires&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Fri, 01 Jan 1990 00:00:00 GMT&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>

        <span class="n">write</span> <span class="o">=</span> <span class="n">start_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headerlist</span><span class="p">)</span>
        <span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Response.http_status_message"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Response.http_status_message">[docs]</a>    <span class="k">def</span> <span class="nf">http_status_message</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the default HTTP status message for the given code.</span>

<span class="sd">        :param code:</span>
<span class="sd">            The HTTP code for which we want a message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">status_reasons</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;Invalid HTTP status code: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">message</span>

</div></div>
<div class="viewcode-block" id="RequestHandler"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler">[docs]</a><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base HTTP request handler.</span>

<span class="sd">    Implements most of ``webapp.RequestHandler`` interface.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: A :class:`Request` instance.</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A :class:`Response` instance.</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A :class:`WSGIApplication` instance.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes this request handler with the given WSGI application,</span>
<span class="sd">        Request and Response.</span>

<span class="sd">        When instantiated by ``webapp.WSGIApplication``, request and response</span>
<span class="sd">        are not set on instantiation. Instead, initialize() is called right</span>
<span class="sd">        after the handler is created to set them.</span>

<span class="sd">        Also in webapp dispatching is done by the WSGI app, while webapp2</span>
<span class="sd">        does it here to allow more flexibility in extended classes: handlers</span>
<span class="sd">        can wrap :meth:`dispatch` to check for conditions before executing the</span>
<span class="sd">        requested method and/or post-process the response.</span>

<span class="sd">        .. note::</span>
<span class="sd">           Parameters are optional only to support webapp&#39;s constructor which</span>
<span class="sd">           doesn&#39;t take any arguments. Consider them as required.</span>

<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        :param response:</span>
<span class="sd">            A :class:`Response` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

<div class="viewcode-block" id="RequestHandler.initialize"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes this request handler with the given WSGI application,</span>
<span class="sd">        Request and Response.</span>

<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        :param response:</span>
<span class="sd">            A :class:`Response` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">active_instance</span>
</div>
<div class="viewcode-block" id="RequestHandler.dispatch"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches the request.</span>

<span class="sd">        This will first check if there&#39;s a handler_method defined in the</span>
<span class="sd">        matched route, and if not it&#39;ll use the method correspondent to the</span>
<span class="sd">        request method (``get()``, ``post()`` etc).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route</span><span class="o">.</span><span class="n">handler_method</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">method_name</span><span class="p">:</span>
            <span class="n">method_name</span> <span class="o">=</span> <span class="n">_normalize_handler_method</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>

        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># 405 Method Not Allowed.</span>
            <span class="c"># The response MUST include an Allow header containing a</span>
            <span class="c"># list of valid methods for the requested resource.</span>
            <span class="c"># http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.6</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_get_handler_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="mi">405</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;Allow&#39;</span><span class="p">,</span> <span class="n">valid</span><span class="p">)])</span>

        <span class="c"># The handler only receives *args if no named variables are set.</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_args</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_kwargs</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.error"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears the response and sets the given HTTP status code.</span>

<span class="sd">        This doesn&#39;t stop code execution; for this, use :meth:`abort`.</span>

<span class="sd">        :param code:</span>
<span class="sd">            HTTP status error code (e.g., 501).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="RequestHandler.abort"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.abort">[docs]</a>    <span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Raises an :class:`HTTPException`.</span>

<span class="sd">        This stops code execution, leaving the HTTP exception to be handled</span>
<span class="sd">        by an exception handler.</span>

<span class="sd">        :param code:</span>
<span class="sd">            HTTP status code (e.g., 404).</span>
<span class="sd">        :param args:</span>
<span class="sd">            Positional arguments to be passed to the exception class.</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">            Keyword arguments to be passed to the exception class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abort</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.redirect"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.redirect">[docs]</a>    <span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issues an HTTP redirect to the given relative URI.</span>

<span class="sd">        The arguments are described in :func:`redirect`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="n">permanent</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="n">abort</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                        <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
                        <span class="n">response</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.redirect_to"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.redirect_to">[docs]</a>    <span class="k">def</span> <span class="nf">redirect_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">_permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">_abort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">_code</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">_body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convenience method mixing :meth:`redirect` and :meth:`uri_for`.</span>

<span class="sd">        The arguments are described in :func:`redirect` and :func:`uri_for`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_for</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="n">_permanent</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="n">_abort</span><span class="p">,</span>
                             <span class="n">code</span><span class="o">=</span><span class="n">_code</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">_body</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="RequestHandler.uri_for"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.uri_for">[docs]</a>    <span class="k">def</span> <span class="nf">uri_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a URI for a named :class:`Route`.</span>

<span class="sd">        .. seealso:: :meth:`Router.build`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="c"># Alias.</span></div>
    <span class="n">url_for</span> <span class="o">=</span> <span class="n">uri_for</span>

<div class="viewcode-block" id="RequestHandler.handle_exception"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestHandler.handle_exception">[docs]</a>    <span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called if this handler throws an exception during execution.</span>

<span class="sd">        The default behavior is to re-raise the exception to be handled by</span>
<span class="sd">        :meth:`WSGIApplication.handle_exception`.</span>

<span class="sd">        :param exception:</span>
<span class="sd">            The exception that was thrown.</span>
<span class="sd">        :param debug_mode:</span>
<span class="sd">            True if the web application is running in debug mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span>

</div></div>
<div class="viewcode-block" id="RedirectHandler"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RedirectHandler">[docs]</a><span class="k">class</span> <span class="nc">RedirectHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Redirects to the given URI for all GET requests.</span>

<span class="sd">    This is intended to be used when defining URI routes. You must provide at</span>
<span class="sd">    least the keyword argument *url* in the route default values. Example::</span>

<span class="sd">        def get_redirect_url(handler, *args, **kwargs):</span>
<span class="sd">            return handler.uri_for(&#39;new-route-name&#39;)</span>

<span class="sd">        app = WSGIApplication([</span>
<span class="sd">            Route(&#39;/old-url&#39;, RedirectHandler, defaults={&#39;_uri&#39;: &#39;/new-url&#39;}),</span>
<span class="sd">            Route(&#39;/other-old-url&#39;, RedirectHandler, defaults={</span>
<span class="sd">                  &#39;_uri&#39;: get_redirect_url}),</span>
<span class="sd">        ])</span>

<span class="sd">    Based on idea from `Tornado`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RedirectHandler.get"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RedirectHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Performs a redirect.</span>

<span class="sd">        Two keyword arguments can be passed through the URI route:</span>

<span class="sd">        - **_uri**: A URI string or a callable that returns a URI. The callable</span>
<span class="sd">          is called passing ``(handler, *args, **kwargs)`` as arguments.</span>
<span class="sd">        - **_code**: The redirect status code. Default is 301 (permanent</span>
<span class="sd">          redirect).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_uri&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">permanent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_permanent&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_code&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="n">permanent</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="cached_property"><a class="viewcode-back" href="../../lib.html#lib.webapp2.cached_property">[docs]</a><span class="k">class</span> <span class="nc">cached_property</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A decorator that converts a function into a lazy property.</span>

<span class="sd">    The function wrapped is called the first time to retrieve the result</span>
<span class="sd">    and then that calculated result is used the next time you access</span>
<span class="sd">    the value::</span>

<span class="sd">        class Foo(object):</span>

<span class="sd">            @cached_property</span>
<span class="sd">            def foo(self):</span>
<span class="sd">                # calculate something important here</span>
<span class="sd">                return 42</span>

<span class="sd">    The class has to have a `__dict__` in order for this property to</span>
<span class="sd">    work.</span>

<span class="sd">    .. note:: Implementation detail: this property is implemented as non-data</span>
<span class="sd">       descriptor.  non-data descriptors are only invoked if there is</span>
<span class="sd">       no entry with the same name in the instance&#39;s __dict__.</span>
<span class="sd">       this allows us to completely get rid of the access function call</span>
<span class="sd">       overhead.  If one choses to invoke __get__ by hand the property</span>
<span class="sd">       will still work as expected because the lookup logic is replicated</span>
<span class="sd">       in __get__ for manual invocation.</span>

<span class="sd">    This class was ported from `Werkzeug`_ and `Flask`_.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_default_value</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__module__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__module__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">doc</span> <span class="ow">or</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">return</span> <span class="n">value</span>

</div>
<div class="viewcode-block" id="BaseRoute"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseRoute">[docs]</a><span class="k">class</span> <span class="nc">BaseRoute</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Interface for URI routes.&quot;&quot;&quot;</span>

    <span class="c">#: The regex template.</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Route name, used to build URIs.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: True if this route is only used for URI generation and never matches.</span>
    <span class="n">build_only</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#: The handler or string in dotted notation to be lazily imported.</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: The custom handler method, if handler is a class.</span>
    <span class="n">handler_method</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: The handler, imported and ready for dispatching.</span>
    <span class="n">handler_adapter</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">build_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes this route.</span>

<span class="sd">        :param template:</span>
<span class="sd">            A regex to be matched.</span>
<span class="sd">        :param handler:</span>
<span class="sd">            A callable or string in dotted notation to be lazily imported,</span>
<span class="sd">            e.g., ``&#39;my.module.MyHandler&#39;`` or ``&#39;my.module.my_function&#39;``.</span>
<span class="sd">        :param name:</span>
<span class="sd">            The name of this route, used to build URIs based on it.</span>
<span class="sd">        :param build_only:</span>
<span class="sd">            If True, this route never matches and is used only to build URIs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">build_only</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;Route </span><span class="si">%r</span><span class="s"> is build_only but doesn&#39;t have a name.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_only</span> <span class="o">=</span> <span class="n">build_only</span>

<div class="viewcode-block" id="BaseRoute.match"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseRoute.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Matches all routes against a request object.</span>

<span class="sd">        The first one that matches is returned.</span>

<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        :returns:</span>
<span class="sd">            A tuple ``(route, args, kwargs)`` if a route matched, or None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseRoute.build"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseRoute.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a URI for this route.</span>

<span class="sd">        :param request:</span>
<span class="sd">            The current :class:`Request` object.</span>
<span class="sd">        :param args:</span>
<span class="sd">            Tuple of positional arguments to build the URI.</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">            Dictionary of keyword arguments to build the URI.</span>
<span class="sd">        :returns:</span>
<span class="sd">            An absolute or relative URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="BaseRoute.get_routes"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseRoute.get_routes">[docs]</a>    <span class="k">def</span> <span class="nf">get_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator to get all routes from a route.</span>

<span class="sd">        :yields:</span>
<span class="sd">            This route or all nested routes that it contains.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="BaseRoute.get_match_routes"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseRoute.get_match_routes">[docs]</a>    <span class="k">def</span> <span class="nf">get_match_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator to get all routes that can be matched from a route.</span>

<span class="sd">        Match routes must implement :meth:`match`.</span>

<span class="sd">        :yields:</span>
<span class="sd">            This route or all nested routes that can be matched.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_only</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="BaseRoute.get_build_routes"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseRoute.get_build_routes">[docs]</a>    <span class="k">def</span> <span class="nf">get_build_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generator to get all routes that can be built from a route.</span>

<span class="sd">        Build routes must implement :meth:`build`.</span>

<span class="sd">        :yields:</span>
<span class="sd">            A tuple ``(name, route)`` for all nested routes that can be built.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span>

</div></div>
<div class="viewcode-block" id="SimpleRoute"><a class="viewcode-back" href="../../lib.html#lib.webapp2.SimpleRoute">[docs]</a><span class="k">class</span> <span class="nc">SimpleRoute</span><span class="p">(</span><span class="n">BaseRoute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A route that is compatible with webapp&#39;s routing mechanism.</span>

<span class="sd">    URI building is not implemented as webapp has rudimentar support for it,</span>
<span class="sd">    and this is the most unknown webapp feature anyway.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="SimpleRoute.regex"><a class="viewcode-back" href="../../lib.html#lib.webapp2.SimpleRoute.regex">[docs]</a>    <span class="k">def</span> <span class="nf">regex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lazy regex compiler.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">+=</span> <span class="s">&#39;$&#39;</span>

        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="SimpleRoute.match"><a class="viewcode-back" href="../../lib.html#lib.webapp2.SimpleRoute.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Matches this route against the current request.</span>

<span class="sd">        .. seealso:: :meth:`BaseRoute.match`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">(),</span> <span class="p">{}</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;SimpleRoute(</span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">)&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Route"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Route">[docs]</a><span class="k">class</span> <span class="nc">Route</span><span class="p">(</span><span class="n">BaseRoute</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A route definition that maps a URI path to a handler.</span>

<span class="sd">    The initial concept was based on `Another Do-It-Yourself Framework`_, by</span>
<span class="sd">    Ian Bicking.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: Default parameters values.</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Sequence of allowed HTTP methods. If not set, all methods are allowed.</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Sequence of allowed URI schemes. If not set, all schemes are allowed.</span>
    <span class="n">schemes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Lazy properties extracted from the route template.</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">reverse_template</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">args_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">kwargs_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">build_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">handler_method</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">schemes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes this route.</span>

<span class="sd">        :param template:</span>
<span class="sd">            A route template to match against the request path. A template</span>
<span class="sd">            can have variables enclosed by ``&lt;&gt;`` that define a name, a</span>
<span class="sd">            regular expression or both. Examples:</span>

<span class="sd">              =================  ==================================</span>
<span class="sd">              Format             Example</span>
<span class="sd">              =================  ==================================</span>
<span class="sd">              ``&lt;name&gt;``         ``&#39;/blog/&lt;year&gt;/&lt;month&gt;&#39;``</span>
<span class="sd">              ``&lt;:regex&gt;``       ``&#39;/blog/&lt;:\d{4}&gt;/&lt;:\d{2}&gt;&#39;``</span>
<span class="sd">              ``&lt;name:regex&gt;``   ``&#39;/blog/&lt;year:\d{4}&gt;/&lt;month:\d{2}&gt;&#39;``</span>
<span class="sd">              =================  ==================================</span>

<span class="sd">            The same template can mix parts with name, regular expression or</span>
<span class="sd">            both.</span>

<span class="sd">            If the name is set, the value of the matched regular expression</span>
<span class="sd">            is passed as keyword argument to the handler. Otherwise it is</span>
<span class="sd">            passed as positional argument.</span>

<span class="sd">            If only the name is set, it will match anything except a slash.</span>
<span class="sd">            So these routes are equivalent::</span>

<span class="sd">                Route(&#39;/&lt;user_id&gt;/settings&#39;, handler=SettingsHandler,</span>
<span class="sd">                      name=&#39;user-settings&#39;)</span>
<span class="sd">                Route(&#39;/&lt;user_id:[^/]+&gt;/settings&#39;, handler=SettingsHandler,</span>
<span class="sd">                      name=&#39;user-settings&#39;)</span>

<span class="sd">            .. note::</span>
<span class="sd">               The handler only receives ``*args`` if no named variables are</span>
<span class="sd">               set. Otherwise, the handler only receives ``**kwargs``. This</span>
<span class="sd">               allows you to set regular expressions that are not captured:</span>
<span class="sd">               just mix named and unnamed variables and the handler will</span>
<span class="sd">               only receive the named ones.</span>

<span class="sd">        :param handler:</span>
<span class="sd">            A callable or string in dotted notation to be lazily imported,</span>
<span class="sd">            e.g., ``&#39;my.module.MyHandler&#39;`` or ``&#39;my.module.my_function&#39;``.</span>
<span class="sd">            It is possible to define a method if the callable is a class,</span>
<span class="sd">            separating it by a colon: ``&#39;my.module.MyHandler:my_method&#39;``.</span>
<span class="sd">            This is a shortcut and has the same effect as defining the</span>
<span class="sd">            `handler_method` parameter.</span>
<span class="sd">        :param name:</span>
<span class="sd">            The name of this route, used to build URIs based on it.</span>
<span class="sd">        :param defaults:</span>
<span class="sd">            Default or extra keywords to be returned by this route. Values</span>
<span class="sd">            also present in the route variables are used to build the URI</span>
<span class="sd">            when they are missing.</span>
<span class="sd">        :param build_only:</span>
<span class="sd">            If True, this route never matches and is used only to build URIs.</span>
<span class="sd">        :param handler_method:</span>
<span class="sd">            The name of a custom handler method to be called, in case `handler`</span>
<span class="sd">            is a class. If not defined, the default behavior is to call the</span>
<span class="sd">            handler method correspondent to the HTTP request method in lower</span>
<span class="sd">            case (e.g., `get()`, `post()` etc).</span>
<span class="sd">        :param methods:</span>
<span class="sd">            A sequence of HTTP methods. If set, the route will only match if</span>
<span class="sd">            the request method is allowed.</span>
<span class="sd">        :param schemes:</span>
<span class="sd">            A sequence of URI schemes, e.g., ``[&#39;http&#39;]`` or ``[&#39;https&#39;]``.</span>
<span class="sd">            If set, the route will only match requests with these schemes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Route</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                    <span class="n">build_only</span><span class="o">=</span><span class="n">build_only</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span> <span class="o">=</span> <span class="n">defaults</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schemes</span> <span class="o">=</span> <span class="n">schemes</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler_method</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;If handler_method is defined in a Route, handler &quot;</span>
                    <span class="s">&quot;can&#39;t have a colon (got </span><span class="si">%r</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="n">handler</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler_method</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler_method</span> <span class="o">=</span> <span class="n">handler_method</span>

    <span class="nd">@cached_property</span>
<div class="viewcode-block" id="Route.regex"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Route.regex">[docs]</a>    <span class="k">def</span> <span class="nf">regex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lazy route template parser.&quot;&quot;&quot;</span>
        <span class="n">regex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args_count</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs_count</span><span class="p">,</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">_parse_route_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span>
                                                   <span class="n">default_sufix</span><span class="o">=</span><span class="s">&#39;[^/]+&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">regex</span>
</div>
<div class="viewcode-block" id="Route.match"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Route.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Matches this route against the current request.</span>

<span class="sd">        :raises:</span>
<span class="sd">            ``exc.HTTPMethodNotAllowed`` if the route defines :attr:`methods`</span>
<span class="sd">            and the request method isn&#39;t allowed.</span>

<span class="sd">        .. seealso:: :meth:`BaseRoute.match`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemes</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">schemes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">:</span>
            <span class="c"># This will be caught by the router, so routes with different</span>
            <span class="c"># methods can be tried.</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPMethodNotAllowed</span><span class="p">()</span>

        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">_get_route_variables</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
</div>
<div class="viewcode-block" id="Route.build"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Route.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a URI for this route.</span>

<span class="sd">        .. seealso:: :meth:`Router.build`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_scheme&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_netloc&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">anchor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_fragment&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">full</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_full&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">scheme</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">netloc</span>

        <span class="k">if</span> <span class="n">full</span> <span class="ow">or</span> <span class="n">scheme</span> <span class="ow">or</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="n">netloc</span> <span class="o">=</span> <span class="n">netloc</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">host</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">scheme</span>

        <span class="n">path</span><span class="p">,</span> <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_urlunsplit</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the URI path for this route.</span>

<span class="sd">        :returns:</span>
<span class="sd">            A tuple ``(path, kwargs)`` with the built URI path and extra</span>
<span class="sd">            keywords to be used as URI query arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Access self.regex just to set the lazy properties.</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">args_count</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;__</span><span class="si">%d</span><span class="s">__&#39;</span> <span class="o">%</span> <span class="n">index</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">regex</span> <span class="ow">in</span> <span class="n">variables</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;Missing argument &quot;</span><span class="si">%s</span><span class="s">&quot; to build URI.&#39;</span> <span class="o">%</span> \
                    <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;URI buiding error: Value &quot;</span><span class="si">%s</span><span class="s">&quot; is not &#39;</span>
                    <span class="s">&#39;supported for argument &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)))</span>

            <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_template</span> <span class="o">%</span> <span class="n">values</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;Route(</span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">, name=</span><span class="si">%r</span><span class="s">, defaults=</span><span class="si">%r</span><span class="s">, build_only=</span><span class="si">%r</span><span class="s">)&gt;&#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaults</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_only</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="BaseHandlerAdapter"><a class="viewcode-back" href="../../lib.html#lib.webapp2.BaseHandlerAdapter">[docs]</a><span class="k">class</span> <span class="nc">BaseHandlerAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A basic adapter to dispatch a handler.</span>

<span class="sd">    This is used when the handler is a simple function: it just calls the</span>
<span class="sd">    handler and returns the resulted response.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: The handler to be dispatched.</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="c"># The handler only receives *args if no named variables are set.</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_args</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_kwargs</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WebappHandlerAdapter"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WebappHandlerAdapter">[docs]</a><span class="k">class</span> <span class="nc">WebappHandlerAdapter</span><span class="p">(</span><span class="n">BaseHandlerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An adapter to dispatch a ``webapp.RequestHandler``.</span>

<span class="sd">    Like in webapp, the handler is constructed, then ``initialize()`` is</span>
<span class="sd">    called, then the method corresponding to the HTTP request method is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">()</span>
        <span class="n">handler</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="n">method_name</span> <span class="o">=</span> <span class="n">_normalize_handler_method</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">method_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">501</span><span class="p">)</span>

        <span class="c"># The handler only receives *args if no named variables are set.</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">route_args</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_kwargs</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Webapp2HandlerAdapter"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Webapp2HandlerAdapter">[docs]</a><span class="k">class</span> <span class="nc">Webapp2HandlerAdapter</span><span class="p">(</span><span class="n">BaseHandlerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An adapter to dispatch a ``webapp2.RequestHandler``.</span>

<span class="sd">    The handler is constructed then ``dispatch()`` is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="Router"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router">[docs]</a><span class="k">class</span> <span class="nc">Router</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A URI router used to match, dispatch and build URIs.&quot;&quot;&quot;</span>

    <span class="c">#: Class used when the route is set as a tuple.</span>
    <span class="n">route_class</span> <span class="o">=</span> <span class="n">SimpleRoute</span>
    <span class="c">#: All routes that can be matched.</span>
    <span class="n">match_routes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: All routes that can be built.</span>
    <span class="n">build_routes</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Handler classes imported lazily.</span>
    <span class="n">handlers</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the router.</span>

<span class="sd">        :param routes:</span>
<span class="sd">            A sequence of :class:`Route` instances or, for simple routes,</span>
<span class="sd">            tuples ``(regex, handler)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_routes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_routes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">routes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">routes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>

<div class="viewcode-block" id="Router.add"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">route</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds a route to this router.</span>

<span class="sd">        :param route:</span>
<span class="sd">            A :class:`Route` instance or, for simple routes, a tuple</span>
<span class="sd">            ``(regex, handler)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="c"># Exceptional case: simple routes defined as a tuple.</span>
            <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">route_class</span><span class="p">(</span><span class="o">*</span><span class="n">route</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">get_match_routes</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">match_routes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">route</span><span class="o">.</span><span class="n">get_build_routes</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">build_routes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="Router.set_matcher"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.set_matcher">[docs]</a>    <span class="k">def</span> <span class="nf">set_matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the function called to match URIs.</span>

<span class="sd">        :param func:</span>
<span class="sd">            A function that receives ``(router, request)`` and returns</span>
<span class="sd">            a tuple ``(route, args, kwargs)`` if any route matches, or</span>
<span class="sd">            raise ``exc.HTTPNotFound`` if no route matched or</span>
<span class="sd">            ``exc.HTTPMethodNotAllowed`` if a route matched but the HTTP</span>
<span class="sd">            method was not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Functions are descriptors, so bind it to this instance with __get__.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Router.set_builder"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.set_builder">[docs]</a>    <span class="k">def</span> <span class="nf">set_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the function called to build URIs.</span>

<span class="sd">        :param func:</span>
<span class="sd">            A function that receives ``(router, request, name, args, kwargs)``</span>
<span class="sd">            and returns a URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Router.set_dispatcher"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.set_dispatcher">[docs]</a>    <span class="k">def</span> <span class="nf">set_dispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the function called to dispatch the handler.</span>

<span class="sd">        :param func:</span>
<span class="sd">            A function that receives ``(router, request, response)``</span>
<span class="sd">            and returns the value returned by the dispatched handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Router.set_adapter"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.set_adapter">[docs]</a>    <span class="k">def</span> <span class="nf">set_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the function that adapts loaded handlers for dispatching.</span>

<span class="sd">        :param func:</span>
<span class="sd">            A function that receives ``(router, handler)`` and returns a</span>
<span class="sd">            handler callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Router.default_matcher"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.default_matcher">[docs]</a>    <span class="k">def</span> <span class="nf">default_matcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Matches all routes against a request object.</span>

<span class="sd">        The first one that matches is returned.</span>

<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        :returns:</span>
<span class="sd">            A tuple ``(route, args, kwargs)`` if a route matched, or None.</span>
<span class="sd">        :raises:</span>
<span class="sd">            ``exc.HTTPNotFound`` if no route matched or</span>
<span class="sd">            ``exc.HTTPMethodNotAllowed`` if a route matched but the HTTP</span>
<span class="sd">            method was not allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method_not_allowed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_routes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">match</span>
            <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPMethodNotAllowed</span><span class="p">:</span>
                <span class="n">method_not_allowed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">method_not_allowed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPMethodNotAllowed</span><span class="p">()</span>

        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPNotFound</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Router.default_builder"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.default_builder">[docs]</a>    <span class="k">def</span> <span class="nf">default_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a URI for a named :class:`Route`.</span>

<span class="sd">        :param request:</span>
<span class="sd">            The current :class:`Request` object.</span>
<span class="sd">        :param name:</span>
<span class="sd">            The route name.</span>
<span class="sd">        :param args:</span>
<span class="sd">            Tuple of positional arguments to build the URI. All positional</span>
<span class="sd">            variables defined in the route must be passed and must conform</span>
<span class="sd">            to the format set in the route. Extra arguments are ignored.</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">            Dictionary of keyword arguments to build the URI. All variables</span>
<span class="sd">            not set in the route default values must be passed and must</span>
<span class="sd">            conform to the format set in the route. Extra keywords are</span>
<span class="sd">            appended as a query string.</span>

<span class="sd">            A few keywords have special meaning:</span>

<span class="sd">            - **_full**: If True, builds an absolute URI.</span>
<span class="sd">            - **_scheme**: URI scheme, e.g., `http` or `https`. If defined,</span>
<span class="sd">              an absolute URI is always returned.</span>
<span class="sd">            - **_netloc**: Network location, e.g., `www.google.com`. If</span>
<span class="sd">              defined, an absolute URI is always returned.</span>
<span class="sd">            - **_fragment**: If set, appends a fragment (or &quot;anchor&quot;) to the</span>
<span class="sd">              generated URI.</span>
<span class="sd">        :returns:</span>
<span class="sd">            An absolute or relative URI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">route</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_routes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">route</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;Route named </span><span class="si">%r</span><span class="s"> is not defined.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">route</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Router.default_dispatcher"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.default_dispatcher">[docs]</a>    <span class="k">def</span> <span class="nf">default_dispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispatches a handler.</span>

<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        :param response:</span>
<span class="sd">            A :class:`Response` instance.</span>
<span class="sd">        :raises:</span>
<span class="sd">            ``exc.HTTPNotFound`` if no route matched or</span>
<span class="sd">            ``exc.HTTPMethodNotAllowed`` if a route matched but the HTTP</span>
<span class="sd">            method was not allowed.</span>
<span class="sd">        :returns:</span>
<span class="sd">            The returned value from the handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">route</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">route</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_args</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_kwargs</span> <span class="o">=</span> <span class="n">rv</span>

        <span class="k">if</span> <span class="n">route</span><span class="o">.</span><span class="n">handler_adapter</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">handler</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">handler</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">handler</span><span class="p">]</span>

            <span class="n">route</span><span class="o">.</span><span class="n">handler_adapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">route</span><span class="o">.</span><span class="n">handler_adapter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Router.default_adapter"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Router.default_adapter">[docs]</a>    <span class="k">def</span> <span class="nf">default_adapter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adapts a handler for dispatching.</span>

<span class="sd">        Because handlers use or implement different dispatching mechanisms,</span>
<span class="sd">        they can be wrapped to use a unified API for dispatching.</span>
<span class="sd">        This way webapp2 can support, for example, a :class:`RequestHandler`</span>
<span class="sd">        class and function views or, for compatibility purposes, a</span>
<span class="sd">        ``webapp.RequestHandler`` class. The adapters follow the same router</span>
<span class="sd">        dispatching API but dispatch each handler type differently.</span>

<span class="sd">        :param handler:</span>
<span class="sd">            A handler callable.</span>
<span class="sd">        :returns:</span>
<span class="sd">            A wrapped handler callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">_webapp</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">_webapp</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
                <span class="c"># Compatible with webapp.RequestHandler.</span>
                <span class="n">adapter</span> <span class="o">=</span> <span class="n">WebappHandlerAdapter</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Default, compatible with webapp2.RequestHandler.</span>
                <span class="n">adapter</span> <span class="o">=</span> <span class="n">Webapp2HandlerAdapter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># A &quot;view&quot; function.</span>
            <span class="n">adapter</span> <span class="o">=</span> <span class="n">BaseHandlerAdapter</span>

        <span class="k">return</span> <span class="n">adapter</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">routes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_routes</span> <span class="o">+</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">build_routes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_routes</span><span class="p">]</span>

        <span class="k">return</span> <span class="s">&#39;&lt;Router(</span><span class="si">%r</span><span class="s">)&gt;&#39;</span> <span class="o">%</span> <span class="n">routes</span>

    <span class="c"># Default matcher, builder, dispatcher and adapter.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">default_matcher</span>
    <span class="n">build</span> <span class="o">=</span> <span class="n">default_builder</span>
    <span class="n">dispatch</span> <span class="o">=</span> <span class="n">default_dispatcher</span>
    <span class="n">adapt</span> <span class="o">=</span> <span class="n">default_adapter</span>

</div>
<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple configuration dictionary for the :class:`WSGIApplication`.&quot;&quot;&quot;</span>

    <span class="c">#: Loaded configurations.</span>
    <span class="n">loaded</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaults</span> <span class="ow">or</span> <span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Config.load_config"><a class="viewcode-back" href="../../lib.html#lib.webapp2.Config.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default_values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_values</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">required_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a configuration for a given key.</span>

<span class="sd">        This can be used by objects that define a default configuration. It</span>
<span class="sd">        will update the app configuration with the default values the first</span>
<span class="sd">        time it is requested, and mark the key as loaded.</span>

<span class="sd">        :param key:</span>
<span class="sd">            A configuration key.</span>
<span class="sd">        :param default_values:</span>
<span class="sd">            Default values defined by a module or class.</span>
<span class="sd">        :param user_values:</span>
<span class="sd">            User values, used when an object can be initialized with</span>
<span class="sd">            configuration. This overrides the app configuration.</span>
<span class="sd">        :param required_keys:</span>
<span class="sd">            Keys that can not be None.</span>
<span class="sd">        :raises:</span>
<span class="sd">            Exception, when a required key is not set or is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_values</span> <span class="ow">or</span> <span class="p">())</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">required_keys</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user_values</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_required</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">required_keys</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">user_values</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">user_values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">required_keys</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_required</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">required_keys</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">config</span>
</div>
    <span class="k">def</span> <span class="nf">_validate_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">required_keys</span><span class="p">):</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required_keys</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s">&#39;Missing configuration keys for </span><span class="si">%r</span><span class="s">: </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">missing</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="RequestContext"><a class="viewcode-back" href="../../lib.html#lib.webapp2.RequestContext">[docs]</a><span class="k">class</span> <span class="nc">RequestContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context for a single request.</span>

<span class="sd">    The context is responsible for setting and cleaning global variables for</span>
<span class="sd">    a request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c">#: A :class:`WSGIApplication` instance.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: WSGI environment dictionary.</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the request context.</span>

<span class="sd">        :param app:</span>
<span class="sd">            An :class:`WSGIApplication` instance.</span>
<span class="sd">        :param environ:</span>
<span class="sd">            A WSGI environment dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enters the request context.</span>

<span class="sd">        :returns:</span>
<span class="sd">            A tuple ``(request, response)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Build request and response.</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">response_class</span><span class="p">()</span>
        <span class="c"># Make active app and response available through the request object.</span>
        <span class="n">request</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="n">request</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">response</span>
        <span class="c"># Register global variables.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">set_globals</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exits the request context.</span>

<span class="sd">        This release the context locals except if an exception is caught</span>
<span class="sd">        in debug mode. In this case they are kept to be inspected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="c"># Unregister global variables.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">clear_globals</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="WSGIApplication"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WSGIApplication">[docs]</a><span class="k">class</span> <span class="nc">WSGIApplication</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WSGI-compliant application.&quot;&quot;&quot;</span>

    <span class="c">#: Allowed request methods.</span>
    <span class="n">allowed_methods</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="s">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s">&#39;OPTIONS&#39;</span><span class="p">,</span> <span class="s">&#39;PUT&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s">&#39;TRACE&#39;</span><span class="p">))</span>
    <span class="c">#: Class used for the request object.</span>
    <span class="n">request_class</span> <span class="o">=</span> <span class="n">Request</span>
    <span class="c">#: Class used for the response object.</span>
    <span class="n">response_class</span> <span class="o">=</span> <span class="n">Response</span>
    <span class="c">#: Class used for the router object.</span>
    <span class="n">router_class</span> <span class="o">=</span> <span class="n">Router</span>
    <span class="c">#: Class used for the request context object.</span>
    <span class="n">request_context_class</span> <span class="o">=</span> <span class="n">RequestContext</span>
    <span class="c">#: Class used for the configuration object.</span>
    <span class="n">config_class</span> <span class="o">=</span> <span class="n">Config</span>
    <span class="c">#: A general purpose flag to indicate development mode: if True, uncaught</span>
    <span class="c">#: exceptions are raised instead of using ``HTTPInternalServerError``.</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#: A :class:`Router` instance with all URIs registered for the application.</span>
    <span class="n">router</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A :class:`Config` instance with the application configuration.</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A dictionary to register objects used during the app lifetime.</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: A dictionary mapping HTTP error codes to callables to handle those</span>
    <span class="c">#: HTTP exceptions. See :meth:`handle_exception`.</span>
    <span class="n">error_handlers</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Active :class:`WSGIApplication` instance. See :meth:`set_globals`.</span>
    <span class="n">app</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Active :class:`Request` instance. See :meth:`set_globals`.</span>
    <span class="n">request</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Same as :attr:`app`, for webapp compatibility. See :meth:`set_globals`.</span>
    <span class="n">active_instance</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the WSGI application.</span>

<span class="sd">        :param routes:</span>
<span class="sd">            A sequence of :class:`Route` instances or, for simple routes,</span>
<span class="sd">            tuples ``(regex, handler)``.</span>
<span class="sd">        :param debug:</span>
<span class="sd">            True to enable debug mode, False otherwise.</span>
<span class="sd">        :param config:</span>
<span class="sd">            A configuration dictionary for the application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_globals</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config_class</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">router</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router_class</span><span class="p">(</span><span class="n">routes</span><span class="p">)</span>

<div class="viewcode-block" id="WSGIApplication.set_globals"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WSGIApplication.set_globals">[docs]</a>    <span class="k">def</span> <span class="nf">set_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers the global variables for app and request.</span>

<span class="sd">        If :mod:`webapp2_extras.local` is available the app and request</span>
<span class="sd">        class attributes are assigned to a proxy object that returns them</span>
<span class="sd">        using thread-local, making the application thread-safe. This can also</span>
<span class="sd">        be used in environments that don&#39;t support threading.</span>

<span class="sd">        If :mod:`webapp2_extras.local` is not available app and request will</span>
<span class="sd">        be assigned directly as class attributes. This should only be used in</span>
<span class="sd">        non-threaded environments (e.g., App Engine Python 2.5).</span>

<span class="sd">        :param app:</span>
<span class="sd">            A :class:`WSGIApplication` instance.</span>
<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
            <span class="n">_local</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
            <span class="n">_local</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
            <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">active_instance</span> <span class="o">=</span> <span class="n">app</span>
            <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
</div>
<div class="viewcode-block" id="WSGIApplication.clear_globals"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WSGIApplication.clear_globals">[docs]</a>    <span class="k">def</span> <span class="nf">clear_globals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clears global variables. See :meth:`set_globals`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
            <span class="n">_local</span><span class="o">.</span><span class="n">__release_local__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
            <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">active_instance</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called by WSGI when a request comes in.</span>

<span class="sd">        :param environ:</span>
<span class="sd">            A WSGI environment.</span>
<span class="sd">        :param start_response:</span>
<span class="sd">            A callable accepting a status code, a list of headers and an</span>
<span class="sd">            optional exception context to start the response.</span>
<span class="sd">        :returns:</span>
<span class="sd">            An iterable with the response to return to the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_methods</span><span class="p">:</span>
                    <span class="c"># 501 Not Implemented.</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPNotImplemented</span><span class="p">()</span>

                <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">rv</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># Try to handle it with a custom error handler.</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_exception</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">rv</span>
                <span class="k">except</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c"># Use the HTTP exception as response.</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c"># Error wasn&#39;t handled so we have nothing else to do.</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_internal_error</span><span class="p">(</span><span class="n">e</span><span class="p">)(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_internal_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Last resource error for :meth:`__call__`.&quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">exc</span><span class="o">.</span><span class="n">HTTPInternalServerError</span><span class="p">()</span>

<div class="viewcode-block" id="WSGIApplication.handle_exception"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WSGIApplication.handle_exception">[docs]</a>    <span class="k">def</span> <span class="nf">handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handles a uncaught exception occurred in :meth:`__call__`.</span>

<span class="sd">        Uncaught exceptions can be handled by error handlers registered in</span>
<span class="sd">        :attr:`error_handlers`. This is a dictionary that maps HTTP status</span>
<span class="sd">        codes to callables that will handle the corresponding error code.</span>
<span class="sd">        If the exception is not an ``HTTPException``, the status code 500</span>
<span class="sd">        is used.</span>

<span class="sd">        The error handlers receive (request, response, exception) and can be</span>
<span class="sd">        a callable or a string in dotted notation to be lazily imported.</span>

<span class="sd">        If no error handler is found, the exception is re-raised.</span>

<span class="sd">        Based on idea from `Flask`_.</span>

<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Request` instance.</span>
<span class="sd">        :param request:</span>
<span class="sd">            A :class:`Response` instance.</span>
<span class="sd">        :param e:</span>
<span class="sd">            The uncaught exception.</span>
<span class="sd">        :returns:</span>
<span class="sd">            The returned value from the error handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">):</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="mi">500</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Re-raise it to be caught by the WSGI app.</span>
            <span class="k">raise</span>
</div>
<div class="viewcode-block" id="WSGIApplication.run"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WSGIApplication.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bare</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs this WSGI-compliant application in a CGI environment.</span>

<span class="sd">        This uses functions provided by ``google.appengine.ext.webapp.util``,</span>
<span class="sd">        if available: ``run_bare_wsgi_app`` and ``run_wsgi_app``.</span>

<span class="sd">        Otherwise, it uses ``wsgiref.handlers.CGIHandler().run()``.</span>

<span class="sd">        :param bare:</span>
<span class="sd">            If True, doesn&#39;t add registered WSGI middleware: use</span>
<span class="sd">            ``run_bare_wsgi_app`` instead of ``run_wsgi_app``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_webapp_util</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bare</span><span class="p">:</span>
                <span class="n">_webapp_util</span><span class="o">.</span><span class="n">run_bare_wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_webapp_util</span><span class="o">.</span><span class="n">run_wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">CGIHandler</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WSGIApplication.get_response"><a class="viewcode-back" href="../../lib.html#lib.webapp2.WSGIApplication.get_response">[docs]</a>    <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a request and returns a response for this app.</span>

<span class="sd">        This is a convenience for unit testing purposes. It receives</span>
<span class="sd">        parameters to build a request and calls the application, returning</span>
<span class="sd">        the resulting response::</span>

<span class="sd">            class HelloHandler(webapp2.RequestHandler):</span>
<span class="sd">                def get(self):</span>
<span class="sd">                    self.response.write(&#39;Hello, world!&#39;)</span>

<span class="sd">            app = webapp2.WSGIapplication([(&#39;/&#39;, HelloHandler)])</span>

<span class="sd">            # Test the app, passing parameters to build a request.</span>
<span class="sd">            response = app.get_response(&#39;/&#39;)</span>
<span class="sd">            assert response.status_int == 200</span>
<span class="sd">            assert response.body == &#39;Hello, world!&#39;</span>

<span class="sd">        :param args:</span>
<span class="sd">            Positional arguments to be passed to ``Request.blank()``.</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">            Keyword arguments to be passed to ``Request.blank()``.</span>
<span class="sd">        :returns:</span>
<span class="sd">            A :class:`Response` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_class</span><span class="o">.</span><span class="n">blank</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

</div></div>
<span class="n">_import_string_error</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">import_string() failed for </span><span class="si">%r</span><span class="s">. Possible reasons are:</span>

<span class="s">- missing __init__.py in a package;</span>
<span class="s">- package or module path not included in sys.path;</span>
<span class="s">- duplicated package or module name taking precedence in sys.path;</span>
<span class="s">- missing module, class, function or variable;</span>

<span class="s">Original exception:</span>

<span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"></span>

<span class="s">Debugged import:</span>

<span class="si">%s</span><span class="s">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="ImportStringError"><a class="viewcode-back" href="../../lib.html#lib.webapp2.ImportStringError">[docs]</a><span class="k">class</span> <span class="nc">ImportStringError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides information about a failed :func:`import_string` attempt.&quot;&quot;&quot;</span>

    <span class="c">#: String in dotted notation that failed to be imported.</span>
    <span class="n">import_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#: Wrapped exception.</span>
    <span class="n">exception</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">import_name</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_name</span> <span class="o">=</span> <span class="n">import_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_import_string_error</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">tracked</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">import_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="p">(</span><span class="n">name</span> <span class="ow">and</span> <span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">part</span>
            <span class="n">imported</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imported</span><span class="p">:</span>
                <span class="n">tracked</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">imported</span><span class="o">.</span><span class="n">__file__</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">track</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;- </span><span class="si">%r</span><span class="s"> found in </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">rv</span> <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">tracked</span><span class="p">]</span>
                <span class="n">track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;- </span><span class="si">%r</span><span class="s"> not found.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">import_name</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">track</span><span class="p">))</span>
                <span class="k">break</span>

        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

</div>
<span class="n">_get_app_error</span> <span class="o">=</span> <span class="s">&#39;WSGIApplication global variable is not set.&#39;</span>
<span class="n">_get_request_error</span> <span class="o">=</span> <span class="s">&#39;Request global variable is not set.&#39;</span>


<div class="viewcode-block" id="get_app"><a class="viewcode-back" href="../../lib.html#lib.webapp2.get_app">[docs]</a><span class="k">def</span> <span class="nf">get_app</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the active app instance.</span>

<span class="sd">    :returns:</span>
<span class="sd">        A :class:`WSGIApplication` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_local</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_local</span><span class="p">,</span> <span class="s">&#39;app&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">_get_app_error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">_get_app_error</span>

    <span class="k">return</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">app</span>

</div>
<div class="viewcode-block" id="get_request"><a class="viewcode-back" href="../../lib.html#lib.webapp2.get_request">[docs]</a><span class="k">def</span> <span class="nf">get_request</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the active request instance.</span>

<span class="sd">    :returns:</span>
<span class="sd">        A :class:`Request` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_local</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">_local</span><span class="p">,</span> <span class="s">&#39;request&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">_get_request_error</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="n">_get_request_error</span>

    <span class="k">return</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">request</span>

</div>
<div class="viewcode-block" id="uri_for"><a class="viewcode-back" href="../../lib.html#lib.webapp2.uri_for">[docs]</a><span class="k">def</span> <span class="nf">uri_for</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="n">_request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A standalone uri_for version that can be passed to templates.</span>

<span class="sd">    .. seealso:: :meth:`Router.build`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">_request</span> <span class="ow">or</span> <span class="n">get_request</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="redirect"><a class="viewcode-back" href="../../lib.html#lib.webapp2.redirect">[docs]</a><span class="k">def</span> <span class="nf">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Issues an HTTP redirect to the given relative URI.</span>

<span class="sd">    This won&#39;t stop code execution unless **abort** is True. A common</span>
<span class="sd">    practice is to return when calling this method::</span>

<span class="sd">        return redirect(&#39;/some-path&#39;)</span>

<span class="sd">    :param uri:</span>
<span class="sd">        A relative or absolute URI (e.g., ``&#39;../flowers.html&#39;``).</span>
<span class="sd">    :param permanent:</span>
<span class="sd">        If True, uses a 301 redirect instead of a 302 redirect.</span>
<span class="sd">    :param abort:</span>
<span class="sd">        If True, raises an exception to perform the redirect.</span>
<span class="sd">    :param code:</span>
<span class="sd">        The redirect status code. Supported codes are 301, 302, 303, 305,</span>
<span class="sd">        and 307.  300 is not supported because it&#39;s not a real redirect</span>
<span class="sd">        and 304 because it&#39;s the answer for a request with defined</span>
<span class="sd">        ``If-Modified-Since`` headers.</span>
<span class="sd">    :param body:</span>
<span class="sd">        Response body, if any.</span>
<span class="sd">    :param request:</span>
<span class="sd">        Optional request object. If not set, uses :func:`get_request`.</span>
<span class="sd">    :param response:</span>
<span class="sd">        Optional response object. If not set, a new response is created.</span>
<span class="sd">    :returns:</span>
<span class="sd">        A :class:`Response` instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">or</span> <span class="n">get_request</span><span class="p">()</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">urlparse</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">permanent</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="mi">301</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="mi">302</span>

    <span class="k">assert</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">305</span><span class="p">,</span> <span class="mi">307</span><span class="p">),</span> \
        <span class="s">&#39;Invalid redirect status code.&#39;</span>

    <span class="k">if</span> <span class="n">abort</span><span class="p">:</span>
        <span class="n">_abort</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;Location&#39;</span><span class="p">,</span> <span class="n">uri</span><span class="p">)])</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">request</span> <span class="ow">or</span> <span class="n">get_request</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">response_class</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uri</span>
    <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">code</span>
    <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

</div>
<div class="viewcode-block" id="redirect_to"><a class="viewcode-back" href="../../lib.html#lib.webapp2.redirect_to">[docs]</a><span class="k">def</span> <span class="nf">redirect_to</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="n">_permanent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">_abort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">_code</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">_body</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_request</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_response</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience function mixing :func:`redirect` and :func:`uri_for`.</span>

<span class="sd">    Issues an HTTP redirect to a named URI built using :func:`uri_for`.</span>

<span class="sd">    :param _name:</span>
<span class="sd">        The route name to redirect to.</span>
<span class="sd">    :param args:</span>
<span class="sd">        Positional arguments to build the URI.</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        Keyword arguments to build the URI.</span>
<span class="sd">    :returns:</span>
<span class="sd">        A :class:`Response` instance.</span>

<span class="sd">    The other arguments are described in :func:`redirect`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uri</span> <span class="o">=</span> <span class="n">uri_for</span><span class="p">(</span><span class="n">_name</span><span class="p">,</span> <span class="n">_request</span><span class="o">=</span><span class="n">_request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">permanent</span><span class="o">=</span><span class="n">_permanent</span><span class="p">,</span> <span class="n">abort</span><span class="o">=</span><span class="n">_abort</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">_code</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">_body</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">_request</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">_response</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="abort"><a class="viewcode-back" href="../../lib.html#lib.webapp2.abort">[docs]</a><span class="k">def</span> <span class="nf">abort</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raises an ``HTTPException``.</span>

<span class="sd">    :param code:</span>
<span class="sd">        An integer that represents a valid HTTP status code.</span>
<span class="sd">    :param args:</span>
<span class="sd">        Positional arguments to instantiate the exception.</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        Keyword arguments to instantiate the exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cls</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No exception is defined for code </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">code</span><span class="p">)</span>

    <span class="k">raise</span> <span class="n">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="import_string"><a class="viewcode-back" href="../../lib.html#lib.webapp2.import_string">[docs]</a><span class="k">def</span> <span class="nf">import_string</span><span class="p">(</span><span class="n">import_name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Imports an object based on a string in dotted notation.</span>

<span class="sd">    Simplified version of the function with same name from `Werkzeug`_.</span>

<span class="sd">    :param import_name:</span>
<span class="sd">        String in dotted notation of the object to be imported.</span>
<span class="sd">    :param silent:</span>
<span class="sd">        If True, import or attribute errors are ignored and None is returned</span>
<span class="sd">        instead of raising an exception.</span>
<span class="sd">    :returns:</span>
<span class="sd">        The imported object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">import_name</span> <span class="o">=</span> <span class="n">_to_utf8</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">import_name</span><span class="p">:</span>
            <span class="n">module</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">import_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">obj</span><span class="p">]),</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">import_name</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">),</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImportStringError</span><span class="p">(</span><span class="n">import_name</span><span class="p">,</span> <span class="n">e</span><span class="p">),</span> <span class="bp">None</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>

</div>
<span class="k">def</span> <span class="nf">_urlunsplit</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">netloc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">fragment</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like ``urlparse.urlunsplit``, but will escape values and urlencode and</span>
<span class="sd">    sort query arguments.</span>

<span class="sd">    :param scheme:</span>
<span class="sd">        URI scheme, e.g., `http` or `https`.</span>
<span class="sd">    :param netloc:</span>
<span class="sd">        Network location, e.g., `localhost:8080` or `www.google.com`.</span>
<span class="sd">    :param path:</span>
<span class="sd">        URI path.</span>
<span class="sd">    :param query:</span>
<span class="sd">        URI query as an escaped string, or a dictionary or list of key-values</span>
<span class="sd">        tuples to build a query.</span>
<span class="sd">    :param fragment:</span>
<span class="sd">        Fragment identifier, also known as &quot;anchor&quot;.</span>
<span class="sd">    :returns:</span>
<span class="sd">        An assembled absolute or relative URI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scheme</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">netloc</span><span class="p">:</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">netloc</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">_to_utf8</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">query</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span>

        <span class="c"># Sort args: commonly needed to build signatures for services.</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">fragment</span><span class="p">:</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">_to_utf8</span><span class="p">(</span><span class="n">fragment</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlunsplit</span><span class="p">((</span><span class="n">scheme</span><span class="p">,</span> <span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">fragment</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_handler_methods</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list of HTTP methods supported by a handler.</span>

<span class="sd">    :param handler:</span>
<span class="sd">        A :class:`RequestHandler` instance.</span>
<span class="sd">    :returns:</span>
<span class="sd">        A list of HTTP methods supported by the handler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">get_app</span><span class="p">()</span><span class="o">.</span><span class="n">allowed_methods</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">_normalize_handler_method</span><span class="p">(</span><span class="n">method</span><span class="p">),</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">methods</span>


<span class="k">def</span> <span class="nf">_normalize_handler_method</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms an HTTP method into a valid Python identifier.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_to_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Encodes a unicode value to UTF-8 if not yet encoded.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_route_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">default_sufix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lazy route template parser.&quot;&quot;&quot;</span>
    <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">reverse_template</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">args_count</span> <span class="o">=</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">_route_re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">template</span><span class="p">):</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="n">last</span><span class="p">:</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">default_sufix</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;__</span><span class="si">%d</span><span class="s">__&#39;</span> <span class="o">%</span> <span class="n">args_count</span>
            <span class="n">args_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">pattern</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(?P&lt;</span><span class="si">%s</span><span class="s">&gt;</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">part</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="n">reverse_template</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s%%</span><span class="s">(</span><span class="si">%s</span><span class="s">)s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">variables</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^</span><span class="si">%s</span><span class="s">$&#39;</span> <span class="o">%</span> <span class="n">expr</span><span class="p">)</span>

    <span class="n">part</span> <span class="o">=</span> <span class="n">template</span><span class="p">[</span><span class="n">last</span><span class="p">:]</span>
    <span class="n">kwargs_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">-</span> <span class="n">args_count</span>
    <span class="n">reverse_template</span> <span class="o">+=</span> <span class="n">part</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^</span><span class="si">%s%s</span><span class="s">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">part</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">regex</span><span class="p">,</span> <span class="n">reverse_template</span><span class="p">,</span> <span class="n">args_count</span><span class="p">,</span> <span class="n">kwargs_count</span><span class="p">,</span> <span class="n">variables</span>


<span class="k">def</span> <span class="nf">_get_route_variables</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">default_kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns (args, kwargs) for a route match.&quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">default_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>


<span class="k">def</span> <span class="nf">_set_thread_safe_app</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Assigns WSGIApplication globals to a proxy pointing to thread-local.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_local</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>  <span class="c"># pragma: no cover</span>
        <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">active_instance</span> <span class="o">=</span> <span class="n">_local</span><span class="p">(</span><span class="s">&#39;app&#39;</span><span class="p">)</span>
        <span class="n">WSGIApplication</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">_local</span><span class="p">(</span><span class="s">&#39;request&#39;</span><span class="p">)</span>


<span class="n">Request</span><span class="o">.</span><span class="n">ResponseClass</span> <span class="o">=</span> <span class="n">Response</span>
<span class="n">Response</span><span class="o">.</span><span class="n">RequestClass</span> <span class="o">=</span> <span class="n">Request</span>
<span class="c"># Alias.</span>
<span class="n">_abort</span> <span class="o">=</span> <span class="n">abort</span>
<span class="c"># Thread-safety support.</span>
<span class="n">_set_thread_safe_app</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/ampush-logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Hermes</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ampush, Inc.
    </div>
  </body>
</html>
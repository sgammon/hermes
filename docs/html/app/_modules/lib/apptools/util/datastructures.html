<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lib.apptools.util.datastructures &mdash; Hermes v2.0 Docs</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     'alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Hermes v2.0 Docs"
          href="../../../../_static/opensearch.xml"/>
    <link rel="top" title="Hermes v2.0 Docs" href="../../../../index.html" />
    <link rel="up" title="lib.apptools" href="../../apptools.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Hermes</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../apptools.html" accesskey="U">lib.apptools</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for lib.apptools.util.datastructures</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="sd">Util: Datastructures</span>

<span class="sd">Holds useful classes and code for managing/manipulating/using specialized datastructures.</span>

<span class="sd">-sam (&lt;sam@momentum.io&gt;)</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="c"># Base Imports</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">logging</span>


<span class="c">## Sentinel</span>
<span class="c"># Small utility class used to create named marker objects.</span>
<div class="viewcode-block" id="Sentinel"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.Sentinel">[docs]</a><span class="k">class</span> <span class="nc">Sentinel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Create a named sentinel object. &#39;&#39;&#39;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_falsy</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">_fake_instance</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">falsy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Construct a new sentinel. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_falsy</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">falsy</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Represent this sentinel as a string. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="s">&#39;&lt;Sentinel &quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Test whether this sentinel is falsy. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_falsy</span><span class="p">)</span>

<span class="c"># Sentinels</span></div>
<span class="n">_EMPTY</span><span class="p">,</span> <span class="n">_TOMBSTONE</span> <span class="o">=</span> <span class="n">Sentinel</span><span class="p">(</span><span class="s">&quot;EMPTY&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span> <span class="n">Sentinel</span><span class="p">(</span><span class="s">&quot;TOMBSTONE&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>


<span class="c">## UtilStruct</span>
<span class="c"># Base class for apptools&#39; utility datastructures, which were shamelessly taken from [Providence/Clarity](http://github.com:sgammon/ProvidenceClarity)</span>
<div class="viewcode-block" id="UtilStruct"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.UtilStruct">[docs]</a><span class="k">class</span> <span class="nc">UtilStruct</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Abstract class for a utility object. &#39;&#39;&#39;</span>

    <span class="n">_type</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c">## Init -- Accept structure fill</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; If handed a dictionary (or something) in init, send it to fillStructure (and do the same for kwargs). &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">struct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fillStructure</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="n">case_sensitive</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fillStructure</span><span class="p">(</span><span class="n">case_sensitive</span><span class="o">=</span><span class="n">case_sensitive</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Type error encountered when trying to fillStructure.&#39;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Current struct: &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Target struct: &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">struct</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_type</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_type</span>

<div class="viewcode-block" id="UtilStruct.serialize"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.UtilStruct.serialize">[docs]</a>    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="UtilStruct.deserialize"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.UtilStruct.deserialize">[docs]</a>    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>


<span class="c">## DictProxy</span>
<span class="c"># Take a data structure, and wrap it in an object so that it&#39;s accessible as ds[x] via getitem/setitem.</span></div></div>
<div class="viewcode-block" id="DictProxy"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy">[docs]</a><span class="k">class</span> <span class="nc">DictProxy</span><span class="p">(</span><span class="n">UtilStruct</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Handy little object that takes a dict and makes it accessible via var[item] and var.item formats. Also handy for caching. &#39;&#39;&#39;</span>

    <span class="c">## Init</span>
<div class="viewcode-block" id="DictProxy.fillStructure"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy.fillStructure">[docs]</a>    <span class="k">def</span> <span class="nf">fillStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Set it as an object directly instead of storing in _entries. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">struct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">struct</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

<div class="viewcode-block" id="DictProxy.extend"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy.extend">[docs]</a>    <span class="k">def</span> <span class="nf">extend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span>
</div>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="c">## Utiliy Methods</span>
<div class="viewcode-block" id="DictProxy.keys"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="DictProxy.values"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="DictProxy.items"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
</div>
<div class="viewcode-block" id="DictProxy.get"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.DictProxy.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Retrieve the named item, returning default_value if it cannot be found. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_value</span>


<span class="c">## ObjectProxy</span>
<span class="c"># Take a datastructure and wrap it in an object that makes it accessible via ds.x, using getattr/setattr.</span></div></div>
<div class="viewcode-block" id="ObjectProxy"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectProxy">[docs]</a><span class="k">class</span> <span class="nc">ObjectProxy</span><span class="p">(</span><span class="n">UtilStruct</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Same handy object as above, but stores the entries in an _entries attribute rather than the class dict.  &#39;&#39;&#39;</span>

    <span class="n">_entries</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span>

<div class="viewcode-block" id="ObjectProxy.fillStructure"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectProxy.fillStructure">[docs]</a>    <span class="k">def</span> <span class="nf">fillStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; If handed a dictionary or kwargs, fill _entries with e[k] = v. A list will do the same and be interpreted as a list of tuples in (k, v) format. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fill</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fill</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fill</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fill</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">case_sensitive</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</div>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;Could not find the attribute &#39;</span><span class="si">%s</span><span class="s">&#39; on the specified ObjectProxy.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i_filter</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

<div class="viewcode-block" id="ObjectProxy.keys"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectProxy.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">entry</span>
</div>
<div class="viewcode-block" id="ObjectProxy.values"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectProxy.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">entry</span>

    <span class="c">## Utiliy Methods</span></div>
<div class="viewcode-block" id="ObjectProxy.items"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectProxy.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>


<span class="c">## WritableObjectProxy</span>
<span class="c"># Same handy class as above, but allows appending things at runtime.</span></div></div>
<div class="viewcode-block" id="WritableObjectProxy"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.WritableObjectProxy">[docs]</a><span class="k">class</span> <span class="nc">WritableObjectProxy</span><span class="p">(</span><span class="n">ObjectProxy</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Same handy object as `ObjectProxy`, but allows appending things at runtime. &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="c">## CallbackProxy</span>
<span class="c"># Take a datastructure and wrap it in an object, such that when a key is requested via ds.x or ds[x], a function is called with that key&#39;s value, and provide the return value (i.e. return callback(d[x])).</span></div>
<div class="viewcode-block" id="CallbackProxy"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.CallbackProxy">[docs]</a><span class="k">class</span> <span class="nc">CallbackProxy</span><span class="p">(</span><span class="n">ObjectProxy</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Handy little object that takes a dict and makes it accessible via var[item], but returns the result of an invoked callback(item). &#39;&#39;&#39;</span>

    <span class="n">_entries</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">callback</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">struct</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Map the callback and fillStructure if we get one via `struct`. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span>

        <span class="k">if</span> <span class="n">struct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span> <span class="o">=</span> <span class="n">struct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">or</span> <span class="p">(</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;CallbackProxy entry pool: &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;CallbackProxy could not resolve entry &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_entries</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">()</span>


<span class="c">## ObjectDictBridge</span>
<span class="c"># Treat an object like a dict, or an object!</span></div>
<div class="viewcode-block" id="ObjectDictBridge"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectDictBridge">[docs]</a><span class="k">class</span> <span class="nc">ObjectDictBridge</span><span class="p">(</span><span class="n">UtilStruct</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Treat an object like a dict, or an object! Assign an object with `ObjectDictBridge(&lt;object&gt;)`. Then access properties with `bridge[item]` or `bridge.item`. &#39;&#39;&#39;</span>

    <span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_object</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ObjectDictBridge</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__setattr__</span><span class="p">(</span><span class="s">&#39;target&#39;</span><span class="p">,</span> <span class="n">target_object</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No object target set for ObjectDictBridge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No object target set for ObjectDictBridge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No object target set for ObjectDictBridge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No object target set for ObjectDictBridge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No object target set for ObjectDictBridge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s">&#39;No object target set for ObjectDictBridge.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Indicates whether this ObjectDictBridge contains the given key. &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="ObjectDictBridge.get"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ObjectDictBridge.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default_value</span>
        <span class="k">return</span> <span class="n">default_value</span>


<span class="c">## StateManager</span>
<span class="c"># Used in the service layer as a mixin for tracking object-level state.</span></div></div>
<div class="viewcode-block" id="StateManager"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.StateManager">[docs]</a><span class="k">class</span> <span class="nc">StateManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Addon class for managing a self.state property. &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">_setstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Set an item in service state. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;service&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_getstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Get an item from service state. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;service&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;service&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">_delstate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Delete an item from service state. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;service&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s">&#39;service&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; `service[key] = value` syntax to set an item in service state. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_setstate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; `var = service[key]` syntax to get an item from service state. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getstate</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; `del service[key] syntax` to delete an item from service state. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_delstate</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>


<span class="c">## ProxiedStructure</span>
<span class="c"># Metaclass for doubly-indexed mappings. Used in BidirectionalEnum.</span></div>
<div class="viewcode-block" id="ProxiedStructure"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.ProxiedStructure">[docs]</a><span class="k">class</span> <span class="nc">ProxiedStructure</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Metaclass for property-gather-enabled classes. &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">mappings</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Read mapped properties, store on the object, along with a reverse mapping. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;ProxiedStructure&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">mappings</span><span class="p">)</span>

        <span class="c"># Init calculated data attributes</span>
        <span class="n">mappings</span><span class="p">[</span><span class="s">&#39;_pmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mappings</span><span class="p">[</span><span class="s">&#39;_plookup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Define __contains__ proxy</span>
        <span class="k">def</span> <span class="nf">_contains</span><span class="p">(</span><span class="n">proxied_o</span><span class="p">,</span> <span class="n">flag_or_value</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39; Bidirectionally-compatible __contains__ replacement. &#39;&#39;&#39;</span>

            <span class="k">return</span> <span class="n">flag_or_value</span> <span class="ow">in</span> <span class="n">proxied_o</span><span class="o">.</span><span class="n">_plookup</span>

        <span class="c"># Define __getitem__ proxy</span>
        <span class="k">def</span> <span class="nf">_getitem</span><span class="p">(</span><span class="n">proxied_o</span><span class="p">,</span> <span class="n">fragment</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39; Attempt to resolve the fragment by a forward, then reverse resolution chain. &#39;&#39;&#39;</span>

            <span class="k">if</span> <span class="n">proxied_o</span><span class="o">.</span><span class="n">__contains__</span><span class="p">(</span><span class="n">fragment</span><span class="p">):</span>

                <span class="k">return</span> <span class="n">proxied_o</span><span class="o">.</span><span class="n">_pmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>

        <span class="c"># Define __setitem__ proxy</span>
        <span class="k">def</span> <span class="nf">_setitem</span><span class="p">(</span><span class="n">proxied_o</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39; Block setitem calls, because this is a complicated object that is supposed to be a modelling tool only. &#39;&#39;&#39;</span>

            <span class="k">raise</span> <span class="bp">NotImplemented</span>

        <span class="c"># Map properties into data and lookup attributes</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">mappings</span><span class="p">[</span><span class="s">&#39;_pmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">mappings</span><span class="p">[</span><span class="s">&#39;_plookup&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])],</span>
            <span class="p">(((</span><span class="n">attr</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">mappings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)))</span>

        <span class="c"># Map methods</span>
        <span class="n">mappings</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;__getitem__&#39;</span><span class="p">:</span> <span class="n">_getitem</span><span class="p">,</span>
            <span class="s">&#39;__setitem__&#39;</span><span class="p">:</span> <span class="n">_setitem</span><span class="p">,</span>
            <span class="s">&#39;__contains__&#39;</span><span class="p">:</span> <span class="n">_contains</span>
        <span class="p">})</span>

        <span class="n">new_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">mappings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_cls</span>


<span class="c">## BidirectionalEnum</span>
<span class="c"># Simple datastructure for mapping small / useful values to larger ones.</span></div>
<div class="viewcode-block" id="BidirectionalEnum"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.BidirectionalEnum">[docs]</a><span class="k">class</span> <span class="nc">BidirectionalEnum</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Small and simple datastructure for mapping static flags to smaller values. &#39;&#39;&#39;</span>

    <span class="n">__singleton__</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ProxiedStructure</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BidirectionalEnum.reverse_resolve"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.BidirectionalEnum.reverse_resolve">[docs]</a>    <span class="k">def</span> <span class="nf">reverse_resolve</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Resolve a mapping, by it&#39;s integer/string code. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_pmap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_pmap</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BidirectionalEnum.forward_resolve"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.BidirectionalEnum.forward_resolve">[docs]</a>    <span class="k">def</span> <span class="nf">forward_resolve</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Resolve a mapping, by it&#39;s string property name. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_pmap</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__getattr__</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="BidirectionalEnum.resolve"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.BidirectionalEnum.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span> <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">forward_resolve</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__serialize__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Flatten down into a structure suitable for storage/transport. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)])</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Flatten down and serialize into JSON. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">__serialize__</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Display a string representation of a flattened self. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="s">&#39;::&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
            <span class="s">&quot;&lt;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
            <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="n">block</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)])</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">__serialize__</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">())]),</span>
            <span class="s">&quot;BiDirectional&gt;&quot;</span>
            <span class="p">])</span>


<span class="c">## TrackedDictionary</span>
<span class="c"># Used in the upcoming Core Sessions API. Keeps track of an objects &quot;dirtyness&quot; (whether it has been modified since first population).</span></div>
<div class="viewcode-block" id="TrackedDictionary"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary">[docs]</a><span class="k">class</span> <span class="nc">TrackedDictionary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Keeps track of modifications and modified state for a dictionary. &#39;&#39;&#39;</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span>

    <span class="n">__data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">__seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
    <span class="n">__dirty</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__target</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">__failfast</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">__mutations</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="p">{},</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Prepare internal data storage. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dirty</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mutations</span> <span class="o">=</span> <span class="n">initial</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="nb">set</span><span class="p">([]),</span> <span class="n">target</span><span class="p">,</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="ne">KeyError</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Retrieve from internal storage. &#39;&#39;&#39;</span>

        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_EMPTY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">_EMPTY</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__failfast</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="p">(</span><span class="s">&quot;TrackedDictionary could not resolve key &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Set a value in internal storage. &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__dirty</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mutations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="ne">KeyError</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Remove an item from internal storage. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mutations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">_TOMBSTONE</span><span class="p">))</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dirty</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        <span class="k">raise</span> <span class="n">exception</span><span class="p">(</span><span class="s">&quot;TrackedDictionary could not delete missing key &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Indicates whether this dictionary is empty or not. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="k">else</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Indicate whether we have a key or not. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__seen</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Return the length of this TrackedDictionary. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Properly allow serialization. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Iterate over keys in internal storage. &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">k</span>

    <span class="k">def</span> <span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; JSON hook. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">__subclasshook__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Check if the provided object is a TrackedDictionary. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">cls</span> <span class="ow">is</span> <span class="n">TrackedDictionary</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="s">&quot;reconcile&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">__dict__</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">__mro__</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="nd">@abc.abstractmethod</span>
<div class="viewcode-block" id="TrackedDictionary.reconcile"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.reconcile">[docs]</a>    <span class="k">def</span> <span class="nf">reconcile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Flatten this object&#39;s mutation pool onto the target object. &#39;&#39;&#39;</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.dirty"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.dirty">[docs]</a>    <span class="k">def</span> <span class="nf">dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Return this object&#39;s `dirty` status. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dirty</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.mutations"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.mutations">[docs]</a>    <span class="k">def</span> <span class="nf">mutations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Return this object&#39;s mutation pool. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__mutations</span><span class="p">[:]</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.update"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Update internal values. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.items"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Return a list of (keys, values). &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.keys"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Return a list of all available keys. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.values"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.values">[docs]</a>    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Return a list of all available values. &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.iteritems"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Yield (keys, values) one at a time. &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.iterkeys"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.iterkeys">[docs]</a>    <span class="k">def</span> <span class="nf">iterkeys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Yield keys one at a time. &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">k</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.itervalues"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.itervalues">[docs]</a>    <span class="k">def</span> <span class="nf">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Yield values one at a time. &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">v</span>
</div>
<div class="viewcode-block" id="TrackedDictionary.get"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.TrackedDictionary.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Retrieve an item, safely, optionally returning `default` if no item could be found. &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__contains__</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default</span>
</div>
    <span class="n">__setattr__</span> <span class="o">=</span> <span class="n">__setitem__</span>
    <span class="n">__getattr__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">__getitem__</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>


<span class="c">## PropertyDescriptor - utility class for wrapping a value + type pair, with options</span></div>
<div class="viewcode-block" id="PropertyDescriptor"><a class="viewcode-back" href="../../../../lib.apptools.util.html#lib.apptools.util.datastructures.PropertyDescriptor">[docs]</a><span class="k">class</span> <span class="nc">PropertyDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Utility class used to encapsulate a name, type, and set of options for a property on a data model. &#39;&#39;&#39;</span>

    <span class="n">__null</span> <span class="o">=</span> <span class="bp">True</span>     <span class="c"># allow null values in this property</span>
    <span class="n">__name</span> <span class="o">=</span> <span class="n">_EMPTY</span>   <span class="c"># name of the property</span>
    <span class="n">__type</span> <span class="o">=</span> <span class="n">_EMPTY</span>   <span class="c"># basetype of the property</span>
    <span class="n">__opts</span> <span class="o">=</span> <span class="n">_EMPTY</span>   <span class="c"># options for implementation classes</span>
    <span class="n">__value</span> <span class="o">=</span> <span class="n">_EMPTY</span>  <span class="c"># the value of this property</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">proptype</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Property initialized and descriptor class. &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        
        <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opts</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span> <span class="n">proptype</span><span class="p">,</span> <span class="n">DictProxy</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Set this property&#39;s internal value. &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
        
        <span class="c"># check type</span>
        <span class="k">if</span> <span class="s">&#39;validate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opts</span> <span class="ow">and</span> <span class="s">&#39;typeless&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opts</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;typeless&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__type</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__null</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Property &quot;</span><span class="si">%s</span><span class="s">&quot; on model instance &quot;</span><span class="si">%s</span><span class="s">&quot; only accepts values of type &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__name</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__type</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;typeless&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__opts</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Get this property&#39;s internal value. &#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">pdb</span><span class="p">;</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

        <span class="c"># if empty, return None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">==</span> <span class="n">_EMPTY</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;__sentinel__&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">__sentinel__</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_EMPTY</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__value</span>

    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Delete this property&#39;s internal value. &#39;&#39;&#39;</span>

        <span class="c"># set value to empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__value</span> <span class="o">=</span> <span class="n">_EMPTY</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/ampush-logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">Hermes</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../apptools.html" >lib.apptools</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ampush, Inc.
    </div>
  </body>
</html>